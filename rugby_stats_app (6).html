
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats Rugby - Juniors R√©gionaux</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dc3545 0%, #8b0000 100%);
            min-height: 100vh;
        }

        .app-container {
            display: block;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid #dc3545;
        }

        .header h1 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .import-btn {
            position: relative;
            overflow: hidden;
        }

        .import-btn input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #dc3545;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: #dc3545;
            font-weight: bold;
        }

        .tab.active {
            background: #dc3545;
            color: white;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 500px;
            border: 3px solid #dc3545;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .player-form {
            display: grid;
            gap: 15px;
            max-width: 500px;
            margin-bottom: 30px;
        }

        .player-form input, .player-form select {
            padding: 10px;
            border: 2px solid #dc3545;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn:hover {
            background: #c82333;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #dc3545;
        }

        .player-card h3 {
            color: #dc3545;
            margin-bottom: 5px;
        }

        .rugby-field {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            background: linear-gradient(to bottom, #dc3545 0%, #dc3545 50%, white 50%, white 100%);
            border: 3px solid #333;
            padding: 20px;
            border-radius: 10px;
        }

        .position-slot {
            background: rgba(255,255,255,0.9);
            padding: 8px;
            margin: 8px;
            border-radius: 5px;
            text-align: center;
            border: 2px solid #dc3545;
        }

        .position-slot select {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .field-row {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }

        .match-form {
            max-width: 600px;
            margin-bottom: 30px;
        }

        .match-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #dc3545;
            border-radius: 8px;
        }

        .matches-list {
            margin-top: 30px;
        }

        .match-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            border-left: 4px solid #dc3545;
        }

        .match-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .match-live {
            max-width: 900px;
            margin: 0 auto;
        }

        .scoreboard {
            background: linear-gradient(135deg, #dc3545, #8b0000);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .score-display {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
        }

        .timer {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .timer-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            color: #dc3545;
            font-weight: bold;
        }

        .score-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .score-btn {
            padding: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            color: white;
            transition: transform 0.2s;
        }

        .score-btn:hover {
            transform: scale(1.05);
        }

        .essai-btn { background: #28a745; }
        .transformation-btn { background: #17a2b8; }
        .penalite-btn { background: #ffc107; color: #333; }
        .carton-btn { background: #6c757d; }
        .remplacement-btn { background: #dc3545; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .player-detail-panel {
            display: none;
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .player-detail-panel.active {
            display: block;
            right: 0;
        }

        .panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .panel-overlay.active {
            display: block;
        }

        .panel-header {
            background: linear-gradient(135deg, #dc3545, #8b0000);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .panel-content {
            padding: 20px;
        }

        .mini-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #dc3545;
        }

        .mini-stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .mini-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            border: 3px solid #dc3545;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #dc3545;
        }

        .modal-content select, .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #dc3545;
            border-radius: 8px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .events-list {
            margin-top: 30px;
        }

        .event-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .players-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        .players-table th, .players-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .players-table th {
            background: #dc3545;
            color: white;
        }

        .carton-jaune {
            background: #ffc107;
            color: #333;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
        }

        .carton-rouge {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #dc3545, #8b0000);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .player-stats-list {
            margin-top: 30px;
        }

        .player-stat-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-stat-item strong {
            color: #dc3545;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .success-indicator {
            color: #28a745;
            font-weight: bold;
        }

        .fail-indicator {
            color: #dc3545;
            font-weight: bold;
        }

        @media print {
            body {
                background: white;
            }
            .header, .tabs, .btn {
                display: none !important;
            }
            .content {
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <div class="header">
            <h1>üèâ Statistiques Rugby - Juniors R√©gionaux</h1>
            <div class="header-actions">
                <button class="btn" onclick="exportData()" style="background: #28a745;">
                    üíæ Exporter les donn√©es
                </button>
                <div class="import-btn">
                    <button class="btn" style="background: #17a2b8;">
                        üì• Importer les donn√©es
                    </button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                </div>
                <button class="btn" onclick="clearAllData()" style="background: #6c757d;">
                    üóëÔ∏è R√©initialiser tout
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'joueurs')">Joueurs</button>
            <button class="tab" onclick="switchTab(event, 'matchs')">Matchs</button>
            <button class="tab" onclick="switchTab(event, 'statistiques')">Statistiques Globales</button>
        </div>

        <div class="content">
            <!-- Onglet Joueurs -->
            <div class="tab-content active" id="joueurs">
                <h2 style="color: #dc3545;">Gestion des Joueurs</h2>
                <div class="player-form">
                    <input type="text" id="playerName" placeholder="Nom du joueur" />
                    <button class="btn" onclick="addPlayer()">Ajouter le joueur</button>
                </div>
                
                <h3 style="margin-top: 40px; color: #dc3545;">Liste des joueurs (par ordre alphab√©tique)</h3>
                <input type="text" id="playerSearch" placeholder="üîç Rechercher un joueur..." style="width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #dc3545; border-radius: 8px; font-size: 16px;" oninput="filterPlayers()">
                <div class="player-stats-list" id="playersStatsList"></div>
            </div>

            <!-- Onglet Matchs -->
            <div class="tab-content" id="matchs">
                <div id="matchsList">
                    <h2 style="color: #dc3545;">Liste des Matchs</h2>
                    <div class="match-form">
                        <input type="text" id="adversaire" placeholder="√âquipe adverse" />
                        <input type="date" id="matchDate" />
                        <input type="text" id="lieu" placeholder="Lieu du match" />
                        <button class="btn" onclick="showCompositionModal()">Cr√©er un nouveau match</button>
                    </div>
                    <div class="matches-list" id="matchesList"></div>
                </div>

                <div id="matchLive" style="display: none;">
                    <button class="btn" onclick="backToMatches()" style="margin-bottom: 20px;">‚Üê Retour aux matchs</button>
                    <button class="btn" onclick="showCompositionModal()" style="margin-bottom: 20px; margin-left: 10px; background: #17a2b8;">üë• Modifier la composition</button>
                    <button class="btn" onclick="showMatchPlayersNumbers()" style="margin-bottom: 20px; margin-left: 10px; background: #ffc107; color: #333;">üî¢ Modifier les num√©ros</button>
                    <div class="match-live">
                        <div class="scoreboard">
                            <h2 id="matchTitle"></h2>
                            <div class="timer" id="timer">00:00</div>
                            <div class="timer-controls">
                                <button class="timer-btn" onclick="startTimer()">‚ñ∂ Start</button>
                                <button class="timer-btn" onclick="pauseTimer()">‚è∏ Pause</button>
                                <button class="timer-btn" onclick="resetTimer()">‚Ü∫ Reset</button>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                                <button class="timer-btn" onclick="adjustTimer(-60)" style="background: #ffc107; color: #333;">-1 min</button>
                                <button class="timer-btn" onclick="adjustTimer(-10)" style="background: #ffc107; color: #333;">-10 sec</button>
                                <button class="timer-btn" onclick="adjustTimer(10)" style="background: #28a745; color: white;">+10 sec</button>
                                <button class="timer-btn" onclick="adjustTimer(60)" style="background: #28a745; color: white;">+1 min</button>
                                <button class="timer-btn" onclick="adjustTimer(300)" style="background: #28a745; color: white;">+5 min</button>
                            </div>
                            <div style="display: flex; justify-content: space-around; align-items: center; margin-top: 30px;">
                                <div>
                                    <p style="font-size: 18px; margin-bottom: 10px;">Notre score</p>
                                    <div class="score-display" id="scoreDisplay">0</div>
                                </div>
                                <div style="font-size: 48px; font-weight: bold;">-</div>
                                <div>
                                    <p style="font-size: 18px; margin-bottom: 10px;" id="adversaryName">Adversaire</p>
                                    <div class="score-display" id="adversaryScore">0</div>
                                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                                        <button class="timer-btn" onclick="addAdversaryScore(5)" style="background: #28a745; color: white;">+5</button>
                                        <button class="timer-btn" onclick="addAdversaryScore(3)" style="background: #ffc107; color: #333;">+3</button>
                                        <button class="timer-btn" onclick="addAdversaryScore(2)" style="background: #17a2b8; color: white;">+2</button>
                                        <button class="timer-btn" onclick="addAdversaryScore(-1)" style="background: #dc3545; color: white;">-1</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="score-actions">
                            <button class="score-btn essai-btn" onclick="openModal('essai')">
                                Essai +5
                            </button>
                            <button class="score-btn transformation-btn" onclick="openModal('transformation')">
                                Transformation +2
                            </button>
                            <button class="score-btn penalite-btn" onclick="openModal('penalite')">
                                P√©nalit√© +3
                            </button>
                            <button class="score-btn carton-btn" onclick="openModal('carton')">
                                Carton
                            </button>
                            <button class="score-btn remplacement-btn" onclick="openModal('remplacement')">
                                Remplacement
                            </button>
                        </div>

                        <div class="events-list" id="eventsList"></div>

                        <h3 style="margin-top: 30px; color: #dc3545;">Temps de jeu des joueurs</h3>
                        <table class="players-table">
                            <thead>
                                <tr>
                                    <th>Num√©ro</th>
                                    <th>Joueur</th>
                                    <th>Temps jou√©</th>
                                    <th>Cartons</th>
                                    <th>Points marqu√©s</th>
                                </tr>
                            </thead>
                            <tbody id="playersStatsTable"></tbody>
                        </table>

                        <button class="btn" onclick="endMatch()" style="margin-top: 30px; background: #8b0000;">Terminer le match</button>
                    </div>
                </div>

                <div id="matchDebrief" style="display: none;">
                    <button class="btn" onclick="backToMatches()" style="margin-bottom: 20px;">‚Üê Retour aux matchs</button>
                    <button class="btn" onclick="exportToPDF()" style="margin-bottom: 20px; margin-left: 10px; background: #28a745;">üìÑ Exporter en PDF</button>
                    <button class="btn" onclick="openPostMatchStats()" style="margin-bottom: 20px; margin-left: 10px; background: #17a2b8;">üìä Ajouter des statistiques</button>
                    <button class="btn" onclick="showMatchPlayersNumbers()" style="margin-bottom: 20px; margin-left: 10px; background: #ffc107; color: #333;">üî¢ Modifier les num√©ros</button>
                    <h2 id="debriefTitle" style="color: #dc3545;"></h2>
                    
                    <div style="background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                        <h3 style="margin-bottom: 20px;">Score final</h3>
                        <div style="display: flex; justify-content: space-around; align-items: center;">
                            <div>
                                <p style="font-size: 18px; margin-bottom: 10px;">Notre √©quipe</p>
                                <div style="font-size: 72px; font-weight: bold;" id="debriefOurScore">0</div>
                            </div>
                            <div style="font-size: 48px; font-weight: bold;">-</div>
                            <div>
                                <p style="font-size: 18px; margin-bottom: 10px;" id="debriefAdversaryName">Adversaire</p>
                                <div style="font-size: 72px; font-weight: bold;" id="debriefAdversaryScore">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px; color: #dc3545;">üë• Composition de l'√©quipe</h3>
                    <div id="debriefComposition" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;"></div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="debriefScore">0</h3>
                            <p>Score final</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="debriefEssais">0</h3>
                            <p>Essais marqu√©s</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="debriefTransformations">0</h3>
                            <p>Transformations</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="debriefPenalites">0</h3>
                            <p>P√©nalit√©s</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; color: #dc3545;">Taux de r√©ussite aux transformations</h3>
                    <div id="transformationStats"></div>

                    <h3 style="margin-top: 30px; color: #dc3545;">Taux de r√©ussite aux p√©nalit√©s</h3>
                    <div id="penaliteStats"></div>

                    <!-- NOUVEAU: Section stats vid√©o dans le d√©brief -->
                    <div id="debriefVideoStats"></div>

                    <h3 style="margin-top: 30px; color: #dc3545;">D√©tails des √©v√©nements</h3>
                    <div id="debriefEvents"></div>

                    <h3 style="margin-top: 30px; color: #dc3545;">Statistiques des joueurs</h3>
                    <table class="players-table">
                        <thead>
                            <tr>
                                <th>Joueur</th>
                                <th>Temps jou√©</th>
                                <th>Points</th>
                                <th>Cartons</th>
                            </tr>
                        </thead>
                        <tbody id="debriefPlayersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Onglet Statistiques Globales -->
            <div class="tab-content" id="statistiques">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #dc3545;">Statistiques Globales de la Saison</h2>
                    <button class="btn" onclick="exportGlobalStatsToPDF()" style="background: #28a745;">üìÑ Exporter en PDF</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="globalTotalMatches">0</h3>
                        <p>Matchs jou√©s</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="globalTotalPoints">0</h3>
                        <p>Points marqu√©s</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="globalTotalEssais">0</h3>
                        <p>Essais marqu√©s</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="globalTotalTransformations">0</h3>
                        <p>Transformations r√©ussies</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="globalTotalPenalites">0</h3>
                        <p>P√©nalit√©s r√©ussies</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="globalTransfoRate">0%</h3>
                        <p>Taux de r√©ussite Transfo</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="globalPenaliteRate">0%</h3>
                        <p>Taux de r√©ussite P√©na</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="globalAverageScore">0</h3>
                        <p>Score moyen par match</p>
                    </div>
                </div>

                <!-- NOUVEAU: Stats vid√©o globales -->
                <div id="globalVideoStats"></div>

                <h3 style="margin-top: 40px; color: #dc3545;">Meilleurs marqueurs</h3>
                <div id="topScorers"></div>

                <h3 style="margin-top: 40px; color: #dc3545;">Meilleurs buteurs (Transformations & P√©nalit√©s)</h3>
                <div id="topKickers"></div>

                <!-- MODIFI√â: Tous les joueurs, pas seulement top 10 -->
                <h3 style="margin-top: 40px; color: #dc3545;">Temps de jeu par joueur (Tous les joueurs)</h3>
                <div id="playTimeChart"></div>

                <h3 style="margin-top: 40px; color: #dc3545;">Historique des matchs</h3>
                <div id="matchHistory"></div>
            </div>
        </div>
    </div>

    <!-- Modal Statistiques Post-Match -->
    <div class="modal" id="postMatchStatsModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: #dc3545;">üìä Statistiques d√©taill√©es du match</h2>
            
            <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
                <button class="tab" id="tabTackles" onclick="switchStatsTab('tackles')" style="flex: 1; min-width: 150px;">Plaquages</button>
                <button class="tab" id="tabKicks" onclick="switchStatsTab('kicks')" style="flex: 1; min-width: 150px;">Tirs au but</button>
                <button class="tab" id="tabTeam" onclick="switchStatsTab('team')" style="flex: 1; min-width: 150px;">√âquipe</button>
            </div>
            
            <!-- Onglet Plaquages -->
            <div id="statsTabTackles" style="display: none;">
                <h3 style="color: #dc3545;">Plaquages par joueur</h3>
                <div id="tacklesPlayersList"></div>
            </div>
            
            <!-- Onglet Tirs au but -->
            <div id="statsTabKicks" style="display: none;">
                <h3 style="color: #dc3545;">Carte des tirs au but</h3>
                <p style="color: #666; margin-bottom: 15px;">S√©lectionnez un buteur puis cliquez sur le terrain pour placer les tirs</p>
                
                <div style="margin-bottom: 20px;">
                    <label><strong>Buteur:</strong></label>
                    <select id="kickerSelect" style="padding: 10px; border: 2px solid #dc3545; border-radius: 8px; width: 100%; margin-top: 5px;">
                        <option value="">S√©lectionner un buteur</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" onclick="setKickType('transformation')" id="btnTransfo" style="background: #17a2b8;">Transformation</button>
                    <button class="btn" onclick="setKickType('penalite')" id="btnPenalite" style="background: #ffc107; color: #333;">P√©nalit√©</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>Mode actuel: <span id="kickModeText">Aucun</span></strong>
                </div>
                
                <div id="rugbyFieldContainer" style="background: #2d8e3e; padding: 20px; border-radius: 10px; position: relative;">
                    <svg id="rugbyField" width="100%" height="600" viewBox="0 0 400 600" style="background: #2d8e3e;">
                        <rect x="0" y="0" width="400" height="600" fill="#2d8e3e" stroke="white" stroke-width="3"/>
                        <line x1="0" y1="132" x2="400" y2="132" stroke="white" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="0" y1="468" x2="400" y2="468" stroke="white" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="0" y1="300" x2="400" y2="300" stroke="white" stroke-width="3"/>
                        <line x1="0" y1="30" x2="400" y2="30" stroke="white" stroke-width="3"/>
                        <line x1="0" y1="570" x2="400" y2="570" stroke="white" stroke-width="3"/>
                        <rect x="180" y="0" width="40" height="30" fill="#ffffff"/>
                        <rect x="185" y="5" width="5" height="25" fill="#8B4513"/>
                        <rect x="210" y="5" width="5" height="25" fill="#8B4513"/>
                        <rect x="180" y="570" width="40" height="30" fill="#ffffff"/>
                        <rect x="185" y="575" width="5" height="25" fill="#8B4513"/>
                        <rect x="210" y="575" width="5" height="25" fill="#8B4513"/>
                        <rect id="fieldClickArea" x="0" y="0" width="400" height="600" fill="transparent" style="cursor: crosshair;"/>
                    </svg>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="undoLastKick()" style="background: #6c757d;">‚Ü∂ Annuler dernier tir</button>
                </div>
                
                <div id="kickerStatsDisplay" style="margin-top: 20px;"></div>
            </div>
            
            <!-- Onglet √âquipe -->
            <div id="statsTabTeam" style="display: none;">
                <h3 style="color: #dc3545;">Statistiques d'√©quipe</h3>
                
                <div style="display: grid; gap: 15px; margin-top: 20px;">
                    <div>
                        <label><strong>Touches rat√©es:</strong></label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                            <button onclick="adjustTeamStat('touchesRatees', -1)" style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">-</button>
                            <input type="number" id="touchesRatees" value="0" min="0" style="padding: 10px; border: 2px solid #dc3545; border-radius: 8px; width: 100px; text-align: center; font-size: 18px; font-weight: bold;">
                            <button onclick="adjustTeamStat('touchesRatees', 1)" style="padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">+</button>
                        </div>
                    </div>
                    
                    <div>
                        <label><strong>En-avants:</strong></label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                            <button onclick="adjustTeamStat('enAvants', -1)" style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">-</button>
                            <input type="number" id="enAvants" value="0" min="0" style="padding: 10px; border: 2px solid #dc3545; border-radius: 8px; width: 100px; text-align: center; font-size: 18px; font-weight: bold;">
                            <button onclick="adjustTeamStat('enAvants', 1)" style="padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">+</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons" style="margin-top: 30px;">
                <button class="btn" style="background: #6c757d;" onclick="closePostMatchStats()">Fermer</button>
                <button class="btn" onclick="savePostMatchStats()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Panneau D√©tails Joueur -->
    <div class="panel-overlay" id="panelOverlay" onclick="closePlayerDetail()"></div>
    <div class="player-detail-panel" id="playerDetailPanel">
        <div class="panel-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="playerDetailName" style="margin: 0; font-size: 24px;"></h2>
                <button onclick="closePlayerDetail()" style="background: white; color: #dc3545; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold;">√ó</button>
            </div>
        </div>
        <div class="panel-content" id="playerDetailBody"></div>
        <div style="padding: 20px; border-top: 2px solid #e0e0e0;">
            <button class="btn" onclick="resetPlayerStats()" style="width: 100%; background: #ffc107; color: #333;">
                üîÑ R√©initialiser les statistiques
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <div id="modalBody"></div>
            <div class="modal-buttons">
                <button class="btn" style="background: #6c757d;" onclick="closeModal()">Annuler</button>
                <button class="btn" onclick="confirmModal()">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal √âdition Joueur -->
    <div class="modal" id="editPlayerModal">
        <div class="modal-content">
            <h2 style="color: #dc3545;">Modifier le joueur</h2>
            <div style="display: grid; gap: 15px; margin: 20px 0;">
                <input type="text" id="editPlayerName" placeholder="Nom du joueur" style="padding: 10px; border: 2px solid #dc3545; border-radius: 8px;">
                <input type="number" id="editPlayerNumber" placeholder="Num√©ro" style="padding: 10px; border: 2px solid #dc3545; border-radius: 8px;">
            </div>
            <div class="modal-buttons">
                <button class="btn" style="background: #6c757d;" onclick="closeEditPlayerModal()">Annuler</button>
                <button class="btn" onclick="confirmEditPlayer()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal √âdition Num√©ro dans Match -->
    <div class="modal" id="editPlayerNumberModal">
        <div class="modal-content">
            <h2 style="color: #dc3545;">Modifier le num√©ro du joueur</h2>
            <p style="margin-bottom: 15px; color: #666;">Cette modification s'appliquera √† tous les matchs et statistiques du joueur.</p>
            <div style="display: grid; gap: 15px; margin: 20px 0;">
                <div>
                    <label style="display: block; margin-bottom: 5px;"><strong>Joueur:</strong></label>
                    <input type="text" id="editMatchPlayerName" readonly style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f8f9fa;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px;"><strong>Nouveau num√©ro:</strong></label>
                    <input type="number" id="editMatchPlayerNumber" placeholder="Num√©ro" min="1" max="99" style="padding: 10px; border: 2px solid #dc3545; border-radius: 8px;">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn" style="background: #6c757d;" onclick="closeEditPlayerNumberModal()">Annuler</button>
                <button class="btn" onclick="confirmEditPlayerNumber()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Liste des joueurs du match pour √©diter les num√©ros -->
    <div class="modal" id="matchPlayersNumbersModal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="color: #dc3545;">üî¢ Modifier les num√©ros des joueurs</h2>
            <p style="margin-bottom: 20px; color: #666;">Cliquez sur le bouton d'√©dition pour modifier le num√©ro d'un joueur.</p>
            
            <div id="matchPlayersNumbersList"></div>
            
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn" onclick="closeMatchPlayersNumbers()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal Composition Simplifi√©e -->
    <div class="modal" id="compositionModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: #dc3545;">üë• Composition de l'√©quipe</h2>
            
            <div style="margin: 20px 0;">
                <input type="text" id="playerSearchCompo" placeholder="üîç Rechercher un joueur..." style="width: 100%; padding: 12px; border: 2px solid #dc3545; border-radius: 8px; font-size: 16px;" oninput="filterCompositionPlayers()">
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <strong style="color: #dc3545; font-size: 24px;" id="titulairesCount">0</strong>
                        <div style="color: #666;">Titulaires (15 max)</div>
                    </div>
                    <div>
                        <strong style="color: #17a2b8; font-size: 24px;" id="remplacantsCount">0</strong>
                        <div style="color: #666;">Rempla√ßants (8 max)</div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color: #dc3545; margin-bottom: 15px;">üèÉ Titulaires (15)</h3>
                    <div id="titulairesSelectionList" style="display: grid; gap: 10px;"></div>
                </div>
                
                <div>
                    <h3 style="color: #17a2b8; margin-bottom: 15px;">üí∫ Rempla√ßants (8)</h3>
                    <div id="remplacantsSelectionList" style="display: grid; gap: 10px;"></div>
                </div>
            </div>

            <h3 style="margin-top: 30px; color: #666; margin-bottom: 15px;">üìã Tous les joueurs disponibles</h3>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Cliquez sur un joueur pour l'ajouter en tant que titulaire ou rempla√ßant</p>
            <div id="availablePlayersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;"></div>
            
            <div class="modal-buttons">
                <button class="btn" style="background: #6c757d;" onclick="closeCompositionModal()">Annuler</button>
                <button class="btn" onclick="confirmComposition()">Enregistrer la composition</button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let composition = {};
        let matches = [];
        let currentMatch = null;
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;
        let currentModalType = '';
        let currentEditingPlayerId = null;
        let currentKickType = null;
        let currentKickerId = null;
        let currentStatsTab = 'tackles';
        let titulaires = [];
        let remplacants = [];
        let currentEditingPlayerIdForNumber = null;

        // Chargement des donn√©es
        function loadData() {
            players = JSON.parse(localStorage.getItem('rugbyPlayers') || '[]');
            
            // Migration: ajouter plaquages aux stats existantes
            players.forEach(p => {
                if (!p.stats.plaquages) {
                    p.stats.plaquages = { reussis: 0, rates: 0 };
                }
                if (!p.stats.touchesRatees) {
                    p.stats.touchesRatees = 0;
                }
                if (!p.stats.enAvants) {
                    p.stats.enAvants = 0;
                }
            });
            
            composition = JSON.parse(localStorage.getItem('rugbyComposition') || '{}');
            matches = JSON.parse(localStorage.getItem('rugbyMatches') || '[]');
        }

        function saveData() {
            localStorage.setItem('rugbyPlayers', JSON.stringify(players));
            localStorage.setItem('rugbyComposition', JSON.stringify(composition));
            localStorage.setItem('rugbyMatches', JSON.stringify(matches));
        }

        // Navigation - CORRIG√â
        function switchTab(event, tabName) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'statistiques') {
                renderGlobalStats();
            }
        }

        // Gestion des joueurs
        function addPlayer() {
            const name = document.getElementById('playerName').value;
            
            if (!name) {
                alert('Veuillez entrer le nom du joueur');
                return;
            }
            
            const existingNumbers = players.map(p => p.number);
            let nextNumber = 1;
            while (existingNumbers.includes(nextNumber)) {
                nextNumber++;
            }
            
            players.push({ 
                id: Date.now(), 
                name, 
                number: nextNumber, 
                position: 'Joueur',
                stats: {
                    totalMatches: 0,
                    totalPoints: 0,
                    essais: 0,
                    transformations: { reussies: 0, tentees: 0 },
                    penalites: { reussies: 0, tentees: 0 },
                    cartonsJaunes: 0,
                    cartonsRouges: 0,
                    tempsTotal: 0,
                    plaquages: { reussis: 0, rates: 0 },
                    touchesRatees: 0,
                    enAvants: 0
                }
            });
            saveData();
            renderPlayersStats();
            
            document.getElementById('playerName').value = '';
        }

        function renderPlayersStats() {
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));
            const list = document.getElementById('playersStatsList');
            list.innerHTML = '';
            
            sortedPlayers.forEach(p => {
                const stats = p.stats;
                const transfoPct = stats.transformations.tentees > 0 ? 
                    Math.round((stats.transformations.reussies / stats.transformations.tentees) * 100) : 0;
                const penalitePct = stats.penalites.tentees > 0 ? 
                    Math.round((stats.penalites.reussies / stats.penalites.tentees) * 100) : 0;
                const minutes = Math.floor(stats.tempsTotal / 60);
                
                // NOUVEAU: Afficher aussi les plaquages
                const totalPlaquages = stats.plaquages.reussis + stats.plaquages.rates;
                const plaquagesPct = totalPlaquages > 0 ? 
                    Math.round((stats.plaquages.reussis / totalPlaquages) * 100) : 0;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'player-stat-item';
                
                const infoDiv = document.createElement('div');
                infoDiv.innerHTML = `
                    <strong style="font-size: 18px;">${p.name}</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Matchs: ${stats.totalMatches} | Points: ${stats.totalPoints} | Essais: ${stats.essais} | 
                        Transfo: ${stats.transformations.reussies}/${stats.transformations.tentees} (${transfoPct}%) | 
                        P√©na: ${stats.penalites.reussies}/${stats.penalites.tentees} (${penalitePct}%) | 
                        Plaquages: ${stats.plaquages.reussis}/${totalPlaquages} (${plaquagesPct}%) | 
                        Temps: ${minutes}min | 
                        Cartons: ${stats.cartonsJaunes}üü® ${stats.cartonsRouges}üü•
                    </div>
                `;
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.display = 'flex';
                buttonsDiv.style.gap = '10px';
                
                const detailBtn = document.createElement('button');
                detailBtn.className = 'btn';
                detailBtn.style.background = '#17a2b8';
                detailBtn.style.fontSize = '12px';
                detailBtn.textContent = 'D√©tails';
                detailBtn.onclick = () => showPlayerDetail(p.id);
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn';
                editBtn.style.background = '#ffc107';
                editBtn.style.color = '#333';
                editBtn.style.fontSize = '12px';
                editBtn.textContent = 'Modifier';
                editBtn.onclick = () => editPlayer(p.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn';
                deleteBtn.style.background = '#6c757d';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.textContent = 'Supprimer';
                deleteBtn.onclick = () => deletePlayer(p.id);
                
                buttonsDiv.appendChild(detailBtn);
                buttonsDiv.appendChild(editBtn);
                buttonsDiv.appendChild(deleteBtn);
                
                itemDiv.appendChild(infoDiv);
                itemDiv.appendChild(buttonsDiv);
                list.appendChild(itemDiv);
            });
        }

        function showPlayerDetail(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            const stats = player.stats;
            const transfoPct = stats.transformations.tentees > 0 ? 
                Math.round((stats.transformations.reussies / stats.transformations.tentees) * 100) : 0;
            const penalitePct = stats.penalites.tentees > 0 ? 
                Math.round((stats.penalites.reussies / stats.penalites.tentees) * 100) : 0;
            const totalMinutes = Math.floor(stats.tempsTotal / 60);
            const avgPoints = stats.totalMatches > 0 ? (stats.totalPoints / stats.totalMatches).toFixed(1) : 0;
            
            // NOUVEAU: Stats plaquages
            const totalPlaquages = stats.plaquages.reussis + stats.plaquages.rates;
            const plaquagesPct = totalPlaquages > 0 ? 
                Math.round((stats.plaquages.reussis / totalPlaquages) * 100) : 0;
            
            document.getElementById('playerDetailName').textContent = player.name;
            document.getElementById('playerDetailBody').innerHTML = `
                <div class="mini-stat">
                    <div class="mini-stat-label">Matchs jou√©s</div>
                    <div class="mini-stat-value">${stats.totalMatches}</div>
                </div>

                <div class="mini-stat">
                    <div class="mini-stat-label">Points marqu√©s</div>
                    <div class="mini-stat-value">${stats.totalPoints}</div>
                </div>

                <div class="mini-stat">
                    <div class="mini-stat-label">Moyenne points/match</div>
                    <div class="mini-stat-value">${avgPoints}</div>
                </div>

                <div class="mini-stat">
                    <div class="mini-stat-label">üèâ Essais marqu√©s</div>
                    <div class="mini-stat-value">${stats.essais}</div>
                </div>

                <h4 style="color: #dc3545; margin: 25px 0 15px 0;">Pr√©cision au pied</h4>

                <div class="mini-stat">
                    <div class="mini-stat-label">üéØ Transformations</div>
                    <div class="mini-stat-value" style="font-size: 18px;">
                        ${stats.transformations.reussies}/${stats.transformations.tentees}
                        <span style="color: ${transfoPct >= 70 ? '#28a745' : transfoPct >= 50 ? '#ffc107' : '#dc3545'}; margin-left: 10px;">${transfoPct}%</span>
                    </div>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px;">
                        <div style="background: ${transfoPct >= 70 ? '#28a745' : transfoPct >= 50 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${transfoPct}%; transition: width 0.3s;"></div>
                    </div>
                </div>

                <div class="mini-stat">
                    <div class="mini-stat-label">ü•Ö P√©nalit√©s</div>
                    <div class="mini-stat-value" style="font-size: 18px;">
                        ${stats.penalites.reussies}/${stats.penalites.tentees}
                        <span style="color: ${penalitePct >= 70 ? '#28a745' : penalitePct >= 50 ? '#ffc107' : '#dc3545'}; margin-left: 10px;">${penalitePct}%</span>
                    </div>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px;">
                        <div style="background: ${penalitePct >= 70 ? '#28a745' : penalitePct >= 50 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${penalitePct}%; transition: width 0.3s;"></div>
                    </div>
                </div>

                <h4 style="color: #dc3545; margin: 25px 0 15px 0;">üí™ D√©fense</h4>

                <div class="mini-stat">
                    <div class="mini-stat-label">Plaquages</div>
                    <div class="mini-stat-value" style="font-size: 18px;">
                        ${stats.plaquages.reussis}/${totalPlaquages}
                        <span style="color: ${plaquagesPct >= 80 ? '#28a745' : plaquagesPct >= 60 ? '#ffc107' : '#dc3545'}; margin-left: 10px;">${plaquagesPct}%</span>
                    </div>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px;">
                        <div style="background: ${plaquagesPct >= 80 ? '#28a745' : plaquagesPct >= 60 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${plaquagesPct}%; transition: width 0.3s;"></div>
                    </div>
                </div>

                <h4 style="color: #dc3545; margin: 25px 0 15px 0;">Temps de jeu & Discipline</h4>

                <div class="mini-stat">
                    <div class="mini-stat-label">‚è±Ô∏è Temps de jeu total</div>
                    <div class="mini-stat-value">${totalMinutes} min</div>
                </div>

                <div class="mini-stat">
                    <div class="mini-stat-label">Cartons</div>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px;">üü®</div>
                            <div style="font-size: 20px; font-weight: bold; color: #ffc107;">${stats.cartonsJaunes}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px;">üü•</div>
                            <div style="font-size: 20px; font-weight: bold; color: #dc3545;">${stats.cartonsRouges}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('playerDetailPanel').classList.add('active');
            document.getElementById('panelOverlay').classList.add('active');
        }

        function closePlayerDetail() {
            document.getElementById('playerDetailPanel').classList.remove('active');
            document.getElementById('panelOverlay').classList.remove('active');
        }

        function deletePlayer(id) {
            if (confirm('Supprimer ce joueur ?')) {
                players = players.filter(p => p.id !== id);
                saveData();
                renderPlayersStats();
            }
        }

        function editPlayer(id) {
            const player = players.find(p => p.id === id);
            if (!player) return;
            
            currentEditingPlayerId = id;
            document.getElementById('editPlayerName').value = player.name;
            document.getElementById('editPlayerNumber').value = player.number;
            document.getElementById('editPlayerModal').classList.add('active');
        }

        function closeEditPlayerModal() {
            document.getElementById('editPlayerModal').classList.remove('active');
            currentEditingPlayerId = null;
        }

        function confirmEditPlayer() {
            const name = document.getElementById('editPlayerName').value;
            const number = document.getElementById('editPlayerNumber').value;
            
            if (!name || !number) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            const player = players.find(p => p.id === currentEditingPlayerId);
            if (player) {
                player.name = name;
                player.number = parseInt(number);
                saveData();
                renderPlayersStats();
                closeEditPlayerModal();
            }
        }

        // NOUVEAU: √âditer le num√©ro d'un joueur depuis la composition du match
        function editPlayerNumberInMatch(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            currentEditingPlayerIdForNumber = playerId;
            document.getElementById('editMatchPlayerName').value = player.name;
            document.getElementById('editMatchPlayerNumber').value = player.number;
            document.getElementById('editPlayerNumberModal').classList.add('active');
        }

        function closeEditPlayerNumberModal() {
            document.getElementById('editPlayerNumberModal').classList.remove('active');
            currentEditingPlayerIdForNumber = null;
        }

        function confirmEditPlayerNumber() {
            const number = document.getElementById('editMatchPlayerNumber').value;
            
            if (!number || number < 1 || number > 99) {
                alert('Veuillez entrer un num√©ro valide (entre 1 et 99)');
                return;
            }
            
            const player = players.find(p => p.id === currentEditingPlayerIdForNumber);
            if (player) {
                player.number = parseInt(number);
                
                // Mettre √† jour le num√©ro dans le match actuel aussi
                if (currentMatch) {
                    const matchPlayer = currentMatch.players.find(p => p.id === currentEditingPlayerIdForNumber);
                    if (matchPlayer) {
                        matchPlayer.number = parseInt(number);
                    }
                    saveMatchData();
                }
                
                saveData();
                
                // Rafra√Æchir l'affichage appropri√©
                if (document.getElementById('matchDebrief').style.display === 'block') {
                    showDebrief();
                } else if (document.getElementById('matchPlayersNumbersModal').classList.contains('active')) {
                    showMatchPlayersNumbers();
                }
                
                closeEditPlayerNumberModal();
                alert('‚úÖ Num√©ro modifi√© avec succ√®s !');
            }
        }

        // NOUVEAU: Afficher la liste des joueurs du match pour modifier les num√©ros
        function showMatchPlayersNumbers() {
            if (!currentMatch || !currentMatch.players) {
                alert('‚ö†Ô∏è Aucun match en cours');
                return;
            }
            
            const list = document.getElementById('matchPlayersNumbersList');
            list.innerHTML = '';
            
            // S√©parer titulaires et rempla√ßants
            const titulaires = currentMatch.players.filter(p => p.positionNumber <= 15).sort((a, b) => a.positionNumber - b.positionNumber);
            const remplacants = currentMatch.players.filter(p => p.positionNumber > 15).sort((a, b) => a.positionNumber - b.positionNumber);
            
            if (titulaires.length > 0) {
                list.innerHTML += '<h4 style="color: #dc3545; margin-bottom: 15px;">üèÉ Titulaires</h4>';
                titulaires.forEach(p => {
                    list.innerHTML += `
                        <div class="player-stat-item" style="margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 16px;">#${p.number} - ${p.name}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Position: ${p.positionNumber}</div>
                            </div>
                            <button class="btn" onclick="editPlayerNumberInMatch(${p.id})" style="background: #17a2b8; font-size: 12px;">
                                ‚úèÔ∏è Modifier
                            </button>
                        </div>
                    `;
                });
            }
            
            if (remplacants.length > 0) {
                list.innerHTML += '<h4 style="color: #dc3545; margin: 25px 0 15px 0;">üí∫ Rempla√ßants</h4>';
                remplacants.forEach(p => {
                    list.innerHTML += `
                        <div class="player-stat-item" style="margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 16px;">#${p.number} - ${p.name}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Position: ${p.positionNumber}</div>
                            </div>
                            <button class="btn" onclick="editPlayerNumberInMatch(${p.id})" style="background: #17a2b8; font-size: 12px;">
                                ‚úèÔ∏è Modifier
                            </button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('matchPlayersNumbersModal').classList.add('active');
        }

        function closeMatchPlayersNumbers() {
            document.getElementById('matchPlayersNumbersModal').classList.remove('active');
            
            // Rafra√Æchir l'affichage si on est en match live
            if (document.getElementById('matchLive').style.display === 'block') {
                renderPlayersStatsTable();
            }
        }

        function resetPlayerStats() {
            const playerName = document.getElementById('playerDetailName').textContent;
            
            if (!confirm(`‚ö†Ô∏è Voulez-vous vraiment r√©initialiser toutes les statistiques de ${playerName} ?\n\nCette action est irr√©versible !`)) {
                return;
            }
            
            const player = players.find(p => p.name === playerName);
            if (player) {
                player.stats = {
                    totalMatches: 0,
                    totalPoints: 0,
                    essais: 0,
                    transformations: { reussies: 0, tentees: 0 },
                    penalites: { reussies: 0, tentees: 0 },
                    cartonsJaunes: 0,
                    cartonsRouges: 0,
                    tempsTotal: 0,
                    plaquages: { reussis: 0, rates: 0 },
                    touchesRatees: 0,
                    enAvants: 0
                };
                saveData();
                renderPlayersStats();
                showPlayerDetail(player.id);
                alert('‚úÖ Statistiques r√©initialis√©es avec succ√®s !');
            }
        }

        function filterPlayers() {
            const search = document.getElementById('playerSearch').value.toLowerCase();
            const items = document.querySelectorAll('#playersStatsList .player-stat-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'flex' : 'none';
            });
        }

        // Composition
        function showCompositionModal() {
            if (players.length === 0) {
                alert('‚ö†Ô∏è Vous devez d\'abord ajouter des joueurs dans l\'onglet "Joueurs" !');
                return;
            }
            
            titulaires = [];
            remplacants = [];
            
            if (currentMatch && currentMatch.composition) {
                Object.entries(currentMatch.composition).forEach(([position, playerId]) => {
                    const pos = parseInt(position);
                    if (pos <= 15 && !titulaires.includes(playerId)) {
                        titulaires.push(playerId);
                    } else if (pos > 15 && !remplacants.includes(playerId)) {
                        remplacants.push(playerId);
                    }
                });
            } else {
                Object.entries(composition).forEach(([position, playerId]) => {
                    const pos = parseInt(position);
                    if (pos <= 15 && !titulaires.includes(playerId)) {
                        titulaires.push(playerId);
                    } else if (pos > 15 && !remplacants.includes(playerId)) {
                        remplacants.push(playerId);
                    }
                });
            }
            
            renderCompositionLists();
            document.getElementById('compositionModal').classList.add('active');
        }

        function closeCompositionModal() {
            document.getElementById('compositionModal').classList.remove('active');
        }

        function renderCompositionLists() {
            const searchTerm = document.getElementById('playerSearchCompo') ? document.getElementById('playerSearchCompo').value.toLowerCase() : '';
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));
            const filteredPlayers = searchTerm ? sortedPlayers.filter(p => p.name.toLowerCase().includes(searchTerm)) : sortedPlayers;
            
            document.getElementById('titulairesCount').textContent = titulaires.length;
            document.getElementById('remplacantsCount').textContent = remplacants.length;
            
            const titulairesDiv = document.getElementById('titulairesSelectionList');
            titulairesDiv.innerHTML = '';
            
            titulaires.forEach(playerId => {
                const player = players.find(p => p.id === playerId);
                if (player) {
                    const card = createPlayerCard(player, 'titulaire');
                    titulairesDiv.appendChild(card);
                }
            });
            
            if (titulaires.length === 0) {
                titulairesDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucun titulaire s√©lectionn√©</p>';
            }
            
            const remplacantsDiv = document.getElementById('remplacantsSelectionList');
            remplacantsDiv.innerHTML = '';
            
            remplacants.forEach(playerId => {
                const player = players.find(p => p.id === playerId);
                if (player) {
                    const card = createPlayerCard(player, 'remplacant');
                    remplacantsDiv.appendChild(card);
                }
            });
            
            if (remplacants.length === 0) {
                remplacantsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucun rempla√ßant s√©lectionn√©</p>';
            }
            
            const availableDiv = document.getElementById('availablePlayersList');
            availableDiv.innerHTML = '';
            
            const availablePlayers = filteredPlayers.filter(p => 
                !titulaires.includes(p.id) && !remplacants.includes(p.id)
            );
            
            availablePlayers.forEach(p => {
                const card = createPlayerCard(p, 'available');
                availableDiv.appendChild(card);
            });
            
            if (availablePlayers.length === 0) {
                availableDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Tous les joueurs sont s√©lectionn√©s</p>';
            }
        }

        function createPlayerCard(player, type) {
            const card = document.createElement('div');
            
            if (type === 'titulaire') {
                card.style.cssText = `
                    padding: 12px;
                    border-radius: 8px;
                    background: #dc3545;
                    color: white;
                    cursor: pointer;
                    transition: all 0.3s;
                    border: 2px solid #dc3545;
                `;
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>#${player.number} - ${player.name}</strong>
                        <span style="font-size: 18px;">‚úï</span>
                    </div>
                `;
                card.onclick = () => removeFromTitulaires(player.id);
            } else if (type === 'remplacant') {
                card.style.cssText = `
                    padding: 12px;
                    border-radius: 8px;
                    background: #17a2b8;
                    color: white;
                    cursor: pointer;
                    transition: all 0.3s;
                    border: 2px solid #17a2b8;
                `;
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>#${player.number} - ${player.name}</strong>
                        <span style="font-size: 18px;">‚úï</span>
                    </div>
                `;
                card.onclick = () => removeFromRemplacants(player.id);
            } else {
                card.style.cssText = `
                    padding: 12px;
                    border-radius: 8px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s;
                    border: 2px solid #e0e0e0;
                `;
                card.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>#${player.number} - ${player.name}</strong>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button style="flex: 1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;" onclick="event.stopPropagation(); addAsTitulaire(${player.id})">
                            üèÉ Titulaire
                        </button>
                        <button style="flex: 1; padding: 8px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;" onclick="event.stopPropagation(); addAsRemplacant(${player.id})">
                            üí∫ Rempla√ßant
                        </button>
                    </div>
                `;
            }
            
            return card;
        }

        function addAsTitulaire(playerId) {
            if (titulaires.length >= 15) {
                alert('‚ö†Ô∏è Vous avez d√©j√† 15 titulaires');
                return;
            }
            titulaires.push(playerId);
            renderCompositionLists();
        }

        function addAsRemplacant(playerId) {
            if (remplacants.length >= 8) {
                alert('‚ö†Ô∏è Vous avez d√©j√† 8 rempla√ßants');
                return;
            }
            remplacants.push(playerId);
            renderCompositionLists();
        }

        function removeFromTitulaires(playerId) {
            titulaires = titulaires.filter(id => id !== playerId);
            renderCompositionLists();
        }

        function removeFromRemplacants(playerId) {
            remplacants = remplacants.filter(id => id !== playerId);
            renderCompositionLists();
        }

        function filterCompositionPlayers() {
            renderCompositionLists();
        }

        function confirmComposition() {
            if (titulaires.length === 0) {
                alert('‚ö†Ô∏è Vous devez s√©lectionner au moins 1 titulaire');
                return;
            }
            
            composition = {};
            
            titulaires.forEach((playerId, index) => {
                composition[index + 1] = playerId;
            });
            
            remplacants.forEach((playerId, index) => {
                composition[index + 16] = playerId;
            });
            
            saveData();
            
            if (!currentMatch) {
                createMatch();
            } else {
                updateCurrentMatchPlayers();
            }
            
            closeCompositionModal();
        }

        function updateCurrentMatchPlayers() {
            if (!currentMatch) return;
            
            const newSelectedPlayers = [];
            
            Object.entries(composition).forEach(([position, playerId]) => {
                const player = players.find(p => p.id === playerId);
                if (player) {
                    const existingPlayer = currentMatch.players.find(p => p.id === player.id);
                    
                    if (existingPlayer) {
                        newSelectedPlayers.push(existingPlayer);
                    } else {
                        newSelectedPlayers.push({
                            ...player,
                            positionNumber: parseInt(position),
                            timeOn: parseInt(position) <= 15 ? timerSeconds : null,
                            totalTime: 0,
                            cartons: [],
                            points: 0
                        });
                    }
                }
            });
            
            currentMatch.players = newSelectedPlayers;
            currentMatch.composition = {...composition};
            saveMatchData();
            
            if (document.getElementById('matchLive').style.display === 'block') {
                renderPlayersStatsTable();
            }
            
            alert('‚úÖ Composition mise √† jour avec succ√®s !');
        }

        // Matchs
        function createMatch() {
            const adversaire = document.getElementById('adversaire').value;
            const date = document.getElementById('matchDate').value;
            const lieu = document.getElementById('lieu').value;
            
            if (!adversaire || !date) {
                alert('Veuillez remplir au moins l\'adversaire et la date');
                return;
            }
            
            const hasComposition = Object.keys(composition).length > 0;
            if (!hasComposition) {
                alert('Veuillez s√©lectionner au moins un joueur dans la composition');
                return;
            }
            
            const selectedPlayers = [];
            for (let i = 1; i <= 23; i++) {
                if (composition[i]) {
                    const player = players.find(p => p.id === composition[i]);
                    if (player) {
                        selectedPlayers.push({
                            ...player,
                            positionNumber: i,
                            timeOn: i <= 15 ? 0 : null,
                            totalTime: 0,
                            cartons: [],
                            points: 0
                        });
                    }
                }
            }
            
            const match = {
                id: Date.now(),
                adversaire,
                date,
                lieu,
                score: 0,
                adversaryScore: 0,
                events: [],
                players: selectedPlayers,
                composition: {...composition},
                finished: false,
                currentTime: 0,
                postMatchStats: null
            };
            
            matches.push(match);
            saveData();
            renderMatches();
            
            document.getElementById('adversaire').value = '';
            document.getElementById('matchDate').value = '';
            document.getElementById('lieu').value = '';
            
            alert('‚úÖ Match cr√©√© avec succ√®s !');
        }

        function renderMatches() {
            const list = document.getElementById('matchesList');
            list.innerHTML = matches.map(m => `
                <div class="match-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <div onclick="openMatch(${m.id})" style="flex: 1; cursor: pointer;">
                        <h3>${m.adversaire}</h3>
                        <p>üìÖ ${new Date(m.date).toLocaleDateString('fr-FR')}</p>
                        <p>üìç ${m.lieu || 'Lieu non pr√©cis√©'}</p>
                        ${m.finished ? `<p><strong>Score final: ${m.score}</strong></p>` : '<p>Match √† jouer</p>'}
                    </div>
                    <button class="btn" style="background: #6c757d; margin-left: 10px;" onclick="deleteMatchClick(event, ${m.id})">Supprimer</button>
                </div>
            `).join('');
        }

        function deleteMatchClick(e, matchId) {
            e.stopPropagation();
            deleteMatch(matchId);
        }

        function openMatch(matchId) {
            const match = matches.find(m => m.id === matchId);
            currentMatch = match;
            
            if (currentMatch.finished) {
                showDebrief();
            } else {
                document.getElementById('matchsList').style.display = 'none';
                document.getElementById('matchLive').style.display = 'block';
                document.getElementById('matchTitle').textContent = `vs ${currentMatch.adversaire}`;
                document.getElementById('scoreDisplay').textContent = currentMatch.score;
                document.getElementById('adversaryName').textContent = currentMatch.adversaire;
                document.getElementById('adversaryScore').textContent = currentMatch.adversaryScore || 0;
                
                if (currentMatch.currentTime !== undefined) {
                    timerSeconds = currentMatch.currentTime;
                }
                
                updateTimer();
                renderEventsList();
                renderPlayersStatsTable();
            }
        }

        function addAdversaryScore(points) {
            if (!currentMatch) return;
            
            currentMatch.adversaryScore = (currentMatch.adversaryScore || 0) + points;
            
            if (currentMatch.adversaryScore < 0) {
                currentMatch.adversaryScore = 0;
            }
            
            document.getElementById('adversaryScore').textContent = currentMatch.adversaryScore;
            saveMatchData();
        }

        function deleteMatch(matchId) {
            if (confirm('Voulez-vous vraiment supprimer ce match ?')) {
                matches = matches.filter(m => m.id !== matchId);
                saveData();
                renderMatches();
            }
        }

        function backToMatches() {
            if (currentMatch && !currentMatch.finished) {
                currentMatch.currentTime = timerSeconds;
                saveMatchData();
            }
            
            document.getElementById('matchsList').style.display = 'block';
            document.getElementById('matchLive').style.display = 'none';
            document.getElementById('matchDebrief').style.display = 'none';
            
            renderMatches();
        }

        // Timer
        function startTimer() {
            if (!timerRunning) {
                timerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimer();
                    updatePlayersTime();
                }, 1000);
            }
        }

        function pauseTimer() {
            timerRunning = false;
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 0;
            updateTimer();
        }

        function adjustTimer(seconds) {
            timerSeconds += seconds;
            
            if (timerSeconds < 0) {
                timerSeconds = 0;
            }
            
            updateTimer();
            
            if (currentMatch) {
                currentMatch.currentTime = timerSeconds;
                saveMatchData();
            }
        }

        function updateTimer() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updatePlayersTime() {
            if (currentMatch) {
                currentMatch.players.forEach(p => {
                    if (p.timeOn !== null) {
                        p.totalTime++;
                    }
                });
                
                currentMatch.currentTime = timerSeconds;
                saveMatchData();
            }
        }

        // Modal
        function openModal(type) {
            currentModalType = type;
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const matchPlayers = currentMatch.players || [];
            const titulairesPlayers = matchPlayers.filter(p => p.positionNumber <= 15);
            const remplacantsPlayers = matchPlayers.filter(p => p.positionNumber > 15);
            
            if (matchPlayers.length === 0) {
                alert('‚ö†Ô∏è Aucun joueur dans la composition du match');
                return;
            }
            
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            
            const createPlayerOptions = () => {
                let html = '<optgroup label="üèÉ Titulaires">';
                html += titulairesPlayers.map(p => `<option value="${p.id}">#${p.number} - ${p.name}</option>`).join('');
                html += '</optgroup>';
                
                if (remplacantsPlayers.length > 0) {
                    html += '<optgroup label="üí∫ Rempla√ßants">';
                    html += remplacantsPlayers.map(p => `<option value="${p.id}">#${p.number} - ${p.name}</option>`).join('');
                    html += '</optgroup>';
                }
                return html;
            };
            
            if (type === 'essai') {
                modalTitle.textContent = 'Essai marqu√©';
                modalBody.innerHTML = `
                    <label>Temps (minutes:secondes):</label>
                    <input type="text" id="eventTime" value="${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}" placeholder="00:00">
                    <label>Joueur:</label>
                    <select id="modalPlayerSelect">
                        <option value="">S√©lectionner le joueur</option>
                        ${createPlayerOptions()}
                    </select>
                `;
            } else if (type === 'transformation') {
                modalTitle.textContent = 'Transformation';
                modalBody.innerHTML = `
                    <label>Temps (minutes:secondes):</label>
                    <input type="text" id="eventTime" value="${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}" placeholder="00:00">
                    <label>Joueur:</label>
                    <select id="modalPlayerSelect">
                        <option value="">S√©lectionner le joueur</option>
                        ${createPlayerOptions()}
                    </select>
                    <div class="checkbox-group">
                        <input type="checkbox" id="transfoSuccess" checked>
                        <label for="transfoSuccess">Transformation r√©ussie</label>
                    </div>
                `;
            } else if (type === 'penalite') {
                modalTitle.textContent = 'P√©nalit√©';
                modalBody.innerHTML = `
                    <label>Temps (minutes:secondes):</label>
                    <input type="text" id="eventTime" value="${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}" placeholder="00:00">
                    <label>Joueur:</label>
                    <select id="modalPlayerSelect">
                        <option value="">S√©lectionner le joueur</option>
                        ${createPlayerOptions()}
                    </select>
                    <div class="checkbox-group">
                        <input type="checkbox" id="penaliteSuccess" checked>
                        <label for="penaliteSuccess">P√©nalit√© r√©ussie</label>
                    </div>
                `;
            } else if (type === 'carton') {
                modalTitle.textContent = 'Carton';
                modalBody.innerHTML = `
                    <label>Temps (minutes:secondes):</label>
                    <input type="text" id="eventTime" value="${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}" placeholder="00:00">
                    <label>Joueur:</label>
                    <select id="modalPlayerSelect">
                        <option value="">S√©lectionner le joueur</option>
                        ${createPlayerOptions()}
                    </select>
                    <label>Type de carton:</label>
                    <select id="cartonType">
                        <option value="jaune">Carton jaune</option>
                        <option value="rouge">Carton rouge</option>
                    </select>
                `;
            } else if (type === 'remplacement') {
                const activePlayers = matchPlayers.filter(p => p.timeOn !== null);
                const benchPlayers = matchPlayers.filter(p => p.timeOn === null);
                
                modalTitle.textContent = 'Remplacement';
                modalBody.innerHTML = `
                    <label>Temps (minutes:secondes):</label>
                    <input type="text" id="eventTime" value="${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}" placeholder="00:00">
                    <label>Joueur qui sort:</label>
                    <select id="playerOut">
                        <option value="">S√©lectionner</option>
                        ${activePlayers.map(p => `<option value="${p.id}">#${p.number} - ${p.name}</option>`).join('')}
                    </select>
                    <label>Joueur qui entre:</label>
                    <select id="playerIn">
                        <option value="">S√©lectionner</option>
                        ${benchPlayers.map(p => `<option value="${p.id}">#${p.number} - ${p.name}</option>`).join('')}
                    </select>
                `;
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function confirmModal() {
            const type = currentModalType;
            
            const eventTimeInput = document.getElementById('eventTime');
            let eventTime = timerSeconds;
            
            if (eventTimeInput) {
                const timeValue = eventTimeInput.value;
                const timeParts = timeValue.split(':');
                if (timeParts.length === 2) {
                    const mins = parseInt(timeParts[0]) || 0;
                    const secs = parseInt(timeParts[1]) || 0;
                    eventTime = mins * 60 + secs;
                }
            }
            
            if (type === 'essai') {
                const playerId = parseInt(document.getElementById('modalPlayerSelect').value);
                if (!playerId) {
                    alert('Veuillez s√©lectionner un joueur');
                    return;
                }
                
                currentMatch.score += 5;
                const player = currentMatch.players.find(p => p.id === playerId);
                player.points += 5;
                
                currentMatch.events.push({
                    type: 'essai',
                    time: eventTime,
                    player: player.name,
                    playerId: playerId,
                    points: 5
                });
                
            } else if (type === 'transformation') {
                const playerId = parseInt(document.getElementById('modalPlayerSelect').value);
                const success = document.getElementById('transfoSuccess').checked;
                
                if (!playerId) {
                    alert('Veuillez s√©lectionner un joueur');
                    return;
                }
                
                const player = currentMatch.players.find(p => p.id === playerId);
                
                if (success) {
                    currentMatch.score += 2;
                    player.points += 2;
                }
                
                currentMatch.events.push({
                    type: 'transformation',
                    time: eventTime,
                    player: player.name,
                    playerId: playerId,
                    points: success ? 2 : 0,
                    success: success
                });
                
            } else if (type === 'penalite') {
                const playerId = parseInt(document.getElementById('modalPlayerSelect').value);
                const success = document.getElementById('penaliteSuccess').checked;
                
                if (!playerId) {
                    alert('Veuillez s√©lectionner un joueur');
                    return;
                }
                
                const player = currentMatch.players.find(p => p.id === playerId);
                
                if (success) {
                    currentMatch.score += 3;
                    player.points += 3;
                }
                
                currentMatch.events.push({
                    type: 'penalite',
                    time: eventTime,
                    player: player.name,
                    playerId: playerId,
                    points: success ? 3 : 0,
                    success: success
                });
                
            } else if (type === 'carton') {
                const playerId = parseInt(document.getElementById('modalPlayerSelect').value);
                const cartonType = document.getElementById('cartonType').value;
                
                if (!playerId) {
                    alert('Veuillez s√©lectionner un joueur');
                    return;
                }
                
                const player = currentMatch.players.find(p => p.id === playerId);
                player.cartons.push({
                    type: cartonType,
                    time: eventTime
                });
                
                currentMatch.events.push({
                    type: 'carton',
                    cartonType: cartonType,
                    time: eventTime,
                    player: player.name,
                    playerId: playerId
                });
                
            } else if (type === 'remplacement') {
                const playerOutId = parseInt(document.getElementById('playerOut').value);
                const playerInId = parseInt(document.getElementById('playerIn').value);
                
                if (!playerOutId || !playerInId) {
                    alert('Veuillez s√©lectionner les deux joueurs');
                    return;
                }
                
                const playerOut = currentMatch.players.find(p => p.id === playerOutId);
                const playerIn = currentMatch.players.find(p => p.id === playerInId);
                
                playerOut.timeOn = null;
                playerIn.timeOn = eventTime;
                
                currentMatch.events.push({
                    type: 'remplacement',
                    time: eventTime,
                    playerOut: playerOut.name,
                    playerIn: playerIn.name
                });
            }
            
            saveMatchData();
            document.getElementById('scoreDisplay').textContent = currentMatch.score;
            renderEventsList();
            renderPlayersStatsTable();
            closeModal();
        }

        function saveMatchData() {
            if (currentMatch) {
                const matchIndex = matches.findIndex(m => m.id === currentMatch.id);
                if (matchIndex !== -1) {
                    matches[matchIndex] = currentMatch;
                    saveData();
                }
            }
        }

        function renderEventsList() {
            const list = document.getElementById('eventsList');
            list.innerHTML = '<h3 style="color: #dc3545;">√âv√©nements du match</h3>';
            
            const reversedEvents = [...currentMatch.events].reverse();
            
            reversedEvents.forEach((e, index) => {
                const actualIndex = currentMatch.events.length - 1 - index;
                const minutes = Math.floor(e.time / 60);
                const seconds = e.time % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.style.display = 'flex';
                eventDiv.style.justifyContent = 'space-between';
                eventDiv.style.alignItems = 'center';
                
                const textDiv = document.createElement('div');
                
                if (e.type === 'essai') {
                    textDiv.innerHTML = `‚è±Ô∏è ${timeStr} - üèâ <strong>Essai</strong> de ${e.player} (+5)`;
                } else if (e.type === 'transformation') {
                    const status = e.success ? '<span class="success-indicator">‚úì R√©ussie</span>' : '<span class="fail-indicator">‚úó Manqu√©e</span>';
                    textDiv.innerHTML = `‚è±Ô∏è ${timeStr} - üéØ <strong>Transformation</strong> de ${e.player} ${status} ${e.success ? '(+2)' : ''}`;
                } else if (e.type === 'penalite') {
                    const status = e.success ? '<span class="success-indicator">‚úì R√©ussie</span>' : '<span class="fail-indicator">‚úó Manqu√©e</span>';
                    textDiv.innerHTML = `‚è±Ô∏è ${timeStr} - ü•Ö <strong>P√©nalit√©</strong> de ${e.player} ${status} ${e.success ? '(+3)' : ''}`;
                } else if (e.type === 'carton') {
                    const cartonEmoji = e.cartonType === 'jaune' ? 'üü®' : 'üü•';
                    textDiv.innerHTML = `‚è±Ô∏è ${timeStr} - ${cartonEmoji} <strong>Carton ${e.cartonType}</strong> pour ${e.player}`;
                } else if (e.type === 'remplacement') {
                    textDiv.innerHTML = `‚è±Ô∏è ${timeStr} - üîÑ <strong>Remplacement:</strong> ${e.playerOut} ‚Üí ${e.playerIn}`;
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn';
                deleteBtn.style.background = '#6c757d';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.style.padding = '5px 10px';
                deleteBtn.textContent = 'Supprimer';
                deleteBtn.onclick = () => deleteEvent(actualIndex);
                
                eventDiv.appendChild(textDiv);
                eventDiv.appendChild(deleteBtn);
                list.appendChild(eventDiv);
            });
        }

        function deleteEvent(eventIndex) {
            if (!confirm('Supprimer cet √©v√©nement ?')) {
                return;
            }
            
            const event = currentMatch.events[eventIndex];
            
            if (event.type === 'essai') {
                currentMatch.score -= 5;
                const player = currentMatch.players.find(p => p.id === event.playerId);
                if (player) player.points -= 5;
            } else if (event.type === 'transformation' && event.success) {
                currentMatch.score -= 2;
                const player = currentMatch.players.find(p => p.id === event.playerId);
                if (player) player.points -= 2;
            } else if (event.type === 'penalite' && event.success) {
                currentMatch.score -= 3;
                const player = currentMatch.players.find(p => p.id === event.playerId);
                if (player) player.points -= 3;
            } else if (event.type === 'carton') {
                const player = currentMatch.players.find(p => p.id === event.playerId);
                if (player) {
                    player.cartons = player.cartons.filter(c => c.time !== event.time || c.type !== event.cartonType);
                }
            } else if (event.type === 'remplacement') {
                const playerOut = currentMatch.players.find(p => p.name === event.playerOut);
                const playerIn = currentMatch.players.find(p => p.name === event.playerIn);
                
                if (playerOut && playerIn) {
                    playerOut.timeOn = 0;
                    playerIn.timeOn = null;
                }
            }
            
            currentMatch.events.splice(eventIndex, 1);
            
            saveMatchData();
            document.getElementById('scoreDisplay').textContent = currentMatch.score;
            renderEventsList();
            renderPlayersStatsTable();
        }

        function renderPlayersStatsTable() {
            const tbody = document.getElementById('playersStatsTable');
            tbody.innerHTML = currentMatch.players.map(p => {
                const minutes = Math.floor(p.totalTime / 60);
                const seconds = p.totalTime % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const cartons = p.cartons.map(c => 
                    `<span class="carton-${c.type}">${c.type === 'jaune' ? 'üü®' : 'üü•'}</span>`
                ).join(' ');
                
                return `
                    <tr>
                        <td>#${p.number}</td>
                        <td>${p.name}</td>
                        <td>${timeStr}</td>
                        <td>${cartons || '-'}</td>
                        <td>${p.points}</td>
                    </tr>
                `;
            }).join('');
        }

        function endMatch() {
            if (!confirm('Voulez-vous vraiment terminer ce match ?')) {
                return;
            }
            
            pauseTimer();
            currentMatch.finished = true;
            currentMatch.finalTime = timerSeconds;
            
            // NOUVEAU: Sauvegarder les stats vid√©o dans les stats globales des joueurs (uniquement si pas d√©j√† sauvegard√©es)
            if (currentMatch.postMatchStats && currentMatch.postMatchStats.tackles && !currentMatch.tacklesAlreadySaved) {
                currentMatch.previousTackles = {};
                currentMatch.players.forEach(matchPlayer => {
                    const player = players.find(p => p.id === matchPlayer.id);
                    if (player && currentMatch.postMatchStats.tackles[matchPlayer.id]) {
                        const tackles = currentMatch.postMatchStats.tackles[matchPlayer.id];
                        
                        // Sauvegarder une copie pour pouvoir retirer plus tard
                        currentMatch.previousTackles[matchPlayer.id] = {
                            reussis: tackles.reussis,
                            rates: tackles.rates
                        };
                        
                        player.stats.plaquages.reussis += tackles.reussis;
                        player.stats.plaquages.rates += tackles.rates;
                    }
                });
                currentMatch.tacklesAlreadySaved = true;
            }
            
            currentMatch.players.forEach(matchPlayer => {
                const player = players.find(p => p.id === matchPlayer.id);
                if (player) {
                    player.stats.totalMatches++;
                    player.stats.totalPoints += matchPlayer.points;
                    player.stats.tempsTotal += matchPlayer.totalTime;
                    
                    matchPlayer.cartons.forEach(c => {
                        if (c.type === 'jaune') player.stats.cartonsJaunes++;
                        else player.stats.cartonsRouges++;
                    });
                }
            });
            
            currentMatch.events.forEach(e => {
                const player = players.find(p => p.id === e.playerId);
                if (player) {
                    if (e.type === 'essai') {
                        player.stats.essais++;
                    } else if (e.type === 'transformation') {
                        player.stats.transformations.tentees++;
                        if (e.success) player.stats.transformations.reussies++;
                    } else if (e.type === 'penalite') {
                        player.stats.penalites.tentees++;
                        if (e.success) player.stats.penalites.reussies++;
                    }
                }
            });
            
            saveMatchData();
            saveData();
            showDebrief();
        }

        function showDebrief() {
            document.getElementById('matchLive').style.display = 'none';
            document.getElementById('matchsList').style.display = 'none';
            document.getElementById('matchDebrief').style.display = 'block';
            
            document.getElementById('debriefTitle').textContent = `D√©brief: vs ${currentMatch.adversaire}`;
            document.getElementById('debriefOurScore').textContent = currentMatch.score;
            document.getElementById('debriefAdversaryName').textContent = currentMatch.adversaire;
            document.getElementById('debriefAdversaryScore').textContent = currentMatch.adversaryScore || 0;
            document.getElementById('debriefScore').textContent = currentMatch.score;
            
            // Composition
            const compositionDiv = document.getElementById('debriefComposition');
            if (currentMatch.composition && Object.keys(currentMatch.composition).length > 0) {
                let titulairesHTML = '<h4 style="color: #dc3545; margin-bottom: 10px;">Titulaires:</h4><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">';
                let remplacantsHTML = '<h4 style="color: #dc3545; margin-bottom: 10px;">Rempla√ßants:</h4><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">';
                
                let titulairesCount = 0;
                let remplacantsCount = 0;
                
                Object.entries(currentMatch.composition).forEach(([position, playerId]) => {
                    const player = players.find(p => p.id === playerId);
                    if (player) {
                        const posNum = parseInt(position);
                        const playerHTML = `
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #dc3545; display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>#${player.number}</strong> ${player.name}</span>
                                <button onclick="editPlayerNumberInMatch(${player.id})" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;" title="Modifier le num√©ro">‚úèÔ∏è</button>
                            </div>
                        `;
                        if (posNum <= 15) {
                            titulairesHTML += playerHTML;
                            titulairesCount++;
                        } else {
                            remplacantsHTML += playerHTML;
                            remplacantsCount++;
                        }
                    }
                });
                
                titulairesHTML += '</div>';
                remplacantsHTML += '</div>';
                
                if (titulairesCount === 0 && remplacantsCount === 0) {
                    compositionDiv.innerHTML = '<p>Aucune composition enregistr√©e</p>';
                } else {
                    compositionDiv.innerHTML = (titulairesCount > 0 ? titulairesHTML : '') + (remplacantsCount > 0 ? remplacantsHTML : '');
                }
            } else {
                compositionDiv.innerHTML = '<p>Aucune composition enregistr√©e</p>';
            }
            
            const essais = currentMatch.events.filter(e => e.type === 'essai').length;
            const transformations = currentMatch.events.filter(e => e.type === 'transformation' && e.success).length;
            const penalites = currentMatch.events.filter(e => e.type === 'penalite' && e.success).length;
            
            document.getElementById('debriefEssais').textContent = essais;
            document.getElementById('debriefTransformations').textContent = transformations;
            document.getElementById('debriefPenalites').textContent = penalites;
            
            // Stats transformations
            const transfoStats = {};
            currentMatch.events.filter(e => e.type === 'transformation').forEach(e => {
                if (!transfoStats[e.player]) {
                    transfoStats[e.player] = { reussies: 0, tentees: 0 };
                }
                transfoStats[e.player].tentees++;
                if (e.success) transfoStats[e.player].reussies++;
            });
            
            const transfoDiv = document.getElementById('transformationStats');
            transfoDiv.innerHTML = Object.keys(transfoStats).length > 0 ? 
                Object.entries(transfoStats).map(([player, stats]) => {
                    const pct = Math.round((stats.reussies / stats.tentees) * 100);
                    return `
                        <div class="player-stat-item">
                            <div>
                                <strong>${player}</strong>: ${stats.reussies}/${stats.tentees} r√©ussies
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: ${pct >= 70 ? '#28a745' : pct >= 50 ? '#ffc107' : '#dc3545'};">
                                ${pct}%
                            </div>
                        </div>
                    `;
                }).join('') : '<p>Aucune transformation tent√©e</p>';
            
            // Stats p√©nalit√©s
            const penaliteStats = {};
            currentMatch.events.filter(e => e.type === 'penalite').forEach(e => {
                if (!penaliteStats[e.player]) {
                    penaliteStats[e.player] = { reussies: 0, tentees: 0 };
                }
                penaliteStats[e.player].tentees++;
                if (e.success) penaliteStats[e.player].reussies++;
            });
            
            const penaliteDiv = document.getElementById('penaliteStats');
            penaliteDiv.innerHTML = Object.keys(penaliteStats).length > 0 ? 
                Object.entries(penaliteStats).map(([player, stats]) => {
                    const pct = Math.round((stats.reussies / stats.tentees) * 100);
                    return `
                        <div class="player-stat-item">
                            <div>
                                <strong>${player}</strong>: ${stats.reussies}/${stats.tentees} r√©ussies
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: ${pct >= 70 ? '#28a745' : pct >= 50 ? '#ffc107' : '#dc3545'};">
                                ${pct}%
                            </div>
                        </div>
                    `;
                }).join('') : '<p>Aucune p√©nalit√© tent√©e</p>';
            
            // NOUVEAU: Afficher la carte des tirs dans le d√©brief
        function renderDebriefKicksMap() {
            const kicksMapDiv = document.createElement('div');
            kicksMapDiv.id = 'debriefKicksMap';
            
            // Ins√©rer apr√®s les stats de p√©nalit√©s et avant les stats vid√©o
            const penaliteStatsDiv = document.getElementById('penaliteStats');
            const videoStatsDiv = document.getElementById('debriefVideoStats');
            
            if (!currentMatch.postMatchStats || !currentMatch.postMatchStats.kicks || currentMatch.postMatchStats.kicks.length === 0) {
                kicksMapDiv.innerHTML = '';
                if (videoStatsDiv.previousElementSibling && videoStatsDiv.previousElementSibling.id === 'debriefKicksMap') {
                    videoStatsDiv.previousElementSibling.remove();
                }
                return;
            }
            
            const kicks = currentMatch.postMatchStats.kicks;
            
            let html = '<h3 style="margin-top: 30px; color: #dc3545;">üéØ Carte des tirs au but</h3>';
            
            // Cr√©er le terrain de rugby avec les tirs
            html += `
                <div style="background: #2d8e3e; padding: 20px; border-radius: 10px; position: relative; margin: 20px 0;">
                    <svg id="debriefRugbyField" width="100%" height="600" viewBox="0 0 400 600" style="background: #2d8e3e;">
                        <rect x="0" y="0" width="400" height="600" fill="#2d8e3e" stroke="white" stroke-width="3"/>
                        <line x1="0" y1="132" x2="400" y2="132" stroke="white" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="0" y1="468" x2="400" y2="468" stroke="white" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="0" y1="300" x2="400" y2="300" stroke="white" stroke-width="3"/>
                        <line x1="0" y1="30" x2="400" y2="30" stroke="white" stroke-width="3"/>
                        <line x1="0" y1="570" x2="400" y2="570" stroke="white" stroke-width="3"/>
                        <rect x="180" y="0" width="40" height="30" fill="#ffffff"/>
                        <rect x="185" y="5" width="5" height="25" fill="#8B4513"/>
                        <rect x="210" y="5" width="5" height="25" fill="#8B4513"/>
                        <rect x="180" y="570" width="40" height="30" fill="#ffffff"/>
                        <rect x="185" y="575" width="5" height="25" fill="#8B4513"/>
                        <rect x="210" y="575" width="5" height="25" fill="#8B4513"/>
            `;
            
            // Ajouter les tirs sur le terrain
            kicks.forEach((kick, index) => {
                const color = kick.success ? '#28a745' : '#dc3545';
                const player = currentMatch.players.find(p => p.id === kick.kickerId);
                const playerName = player ? player.name : 'Inconnu';
                const kickType = kick.type === 'transformation' ? 'Transfo' : 'P√©na';
                const kickStatus = kick.success ? 'r√©ussie' : 'rat√©e';
                
                html += `
                    <circle cx="${kick.x}" cy="${kick.y}" r="8" fill="${color}" stroke="white" stroke-width="2" class="kick-ball">
                        <title>${kickType} ${kickStatus} - ${playerName}</title>
                    </circle>
                `;
            });
            
            html += '</svg></div>';
            
            // L√©gende
            html += `
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background: #28a745; border: 2px solid white;"></div>
                        <span>Tir r√©ussi</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background: #dc3545; border: 2px solid white;"></div>
                        <span>Tir rat√©</span>
                    </div>
                </div>
            `;
            
            // Statistiques par joueur
            html += '<h4 style="margin-top: 30px; color: #dc3545;">üìä D√©tails des buteurs</h4>';
            
            const kickerStats = {};
            kicks.forEach(kick => {
                if (!kickerStats[kick.kickerId]) {
                    const player = currentMatch.players.find(p => p.id === kick.kickerId);
                    kickerStats[kick.kickerId] = {
                        name: player ? player.name : 'Inconnu',
                        transformations: { reussies: 0, tentees: 0 },
                        penalites: { reussies: 0, tentees: 0 }
                    };
                }
                
                if (kick.type === 'transformation') {
                    kickerStats[kick.kickerId].transformations.tentees++;
                    if (kick.success) kickerStats[kick.kickerId].transformations.reussies++;
                } else {
                    kickerStats[kick.kickerId].penalites.tentees++;
                    if (kick.success) kickerStats[kick.kickerId].penalites.reussies++;
                }
            });
            
            Object.values(kickerStats).forEach(kicker => {
                const transfoPct = kicker.transformations.tentees > 0 ? 
                    Math.round((kicker.transformations.reussies / kicker.transformations.tentees) * 100) : 0;
                const penalitePct = kicker.penalites.tentees > 0 ? 
                    Math.round((kicker.penalites.reussies / kicker.penalites.tentees) * 100) : 0;
                
                const totalReussies = kicker.transformations.reussies + kicker.penalites.reussies;
                const totalTentees = kicker.transformations.tentees + kicker.penalites.tentees;
                const totalPct = totalTentees > 0 ? Math.round((totalReussies / totalTentees) * 100) : 0;
                
                html += `
                    <div class="player-stat-item">
                        <div style="flex: 1;">
                            <strong style="font-size: 18px;">${kicker.name}</strong>
                            <div style="font-size: 14px; color: #666; margin-top: 8px;">
                                üéØ Transformations: ${kicker.transformations.reussies}/${kicker.transformations.tentees} 
                                <span style="color: ${transfoPct >= 70 ? '#28a745' : transfoPct >= 50 ? '#ffc107' : '#dc3545'}; font-weight: bold;">(${transfoPct}%)</span>
                                ${kicker.transformations.tentees > 0 ? ' | ' : ''}
                                ${kicker.penalites.tentees > 0 ? `ü•Ö P√©nalit√©s: ${kicker.penalites.reussies}/${kicker.penalites.tentees} 
                                <span style="color: ${penalitePct >= 70 ? '#28a745' : penalitePct >= 50 ? '#ffc107' : '#dc3545'}; font-weight: bold;">(${penalitePct}%)</span>` : ''}
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: ${totalPct >= 70 ? '#28a745' : totalPct >= 50 ? '#ffc107' : '#dc3545'};">
                                ${totalPct}%
                            </div>
                            <div style="font-size: 12px; color: #666;">Global</div>
                        </div>
                    </div>
                `;
            });
            
            kicksMapDiv.innerHTML = html;
            
            // Supprimer l'ancienne version si elle existe
            const existingMap = document.getElementById('debriefKicksMap');
            if (existingMap) {
                existingMap.remove();
            }
            
            // Ins√©rer avant les stats vid√©o
            videoStatsDiv.parentNode.insertBefore(kicksMapDiv, videoStatsDiv);
        }

        // NOUVEAU: Afficher les stats vid√©o dans le d√©brief
            renderDebriefVideoStats();
            
            // NOUVEAU: Afficher la carte des transformations
            renderDebriefKicksMap();
            
            const eventsDiv = document.getElementById('debriefEvents');
            eventsDiv.innerHTML = currentMatch.events.map(e => {
                const minutes = Math.floor(e.time / 60);
                const seconds = e.time % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (e.type === 'essai') {
                    return `<div class="event-item">‚è±Ô∏è ${timeStr} - üèâ Essai de ${e.player} (+5)</div>`;
                } else if (e.type === 'transformation') {
                    const status = e.success ? '‚úì R√©ussie' : '‚úó Manqu√©e';
                    return `<div class="event-item">‚è±Ô∏è ${timeStr} - üéØ Transformation de ${e.player} ${status} ${e.success ? '(+2)' : ''}</div>`;
                } else if (e.type === 'penalite') {
                    const status = e.success ? '‚úì R√©ussie' : '‚úó Manqu√©e';
                    return `<div class="event-item">‚è±Ô∏è ${timeStr} - ü•Ö P√©nalit√© de ${e.player} ${status} ${e.success ? '(+3)' : ''}</div>`;
                } else if (e.type === 'carton') {
                    const cartonEmoji = e.cartonType === 'jaune' ? 'üü®' : 'üü•';
                    return `<div class="event-item">‚è±Ô∏è ${timeStr} - ${cartonEmoji} Carton ${e.cartonType} pour ${e.player}</div>`;
                } else if (e.type === 'remplacement') {
                    return `<div class="event-item">‚è±Ô∏è ${timeStr} - üîÑ ${e.playerOut} ‚Üí ${e.playerIn}</div>`;
                }
            }).join('');
            
            const tbody = document.getElementById('debriefPlayersTable');
            tbody.innerHTML = currentMatch.players.map(p => {
                const minutes = Math.floor(p.totalTime / 60);
                const seconds = p.totalTime % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const cartons = p.cartons.map(c => 
                    `<span class="carton-${c.type}">${c.type === 'jaune' ? 'Jaune' : 'Rouge'}</span>`
                ).join(', ');
                
                return `
                    <tr>
                        <td>#${p.number} - ${p.name}</td>
                        <td>${timeStr}</td>
                        <td>${p.points}</td>
                        <td>${cartons || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // NOUVEAU: Afficher les stats vid√©o dans le d√©brief
        function renderDebriefVideoStats() {
            const videoStatsDiv = document.getElementById('debriefVideoStats');
            
            if (!currentMatch.postMatchStats) {
                videoStatsDiv.innerHTML = '';
                return;
            }
            
            const stats = currentMatch.postMatchStats;
            
            let html = '<h3 style="margin-top: 30px; color: #dc3545;">üìπ Statistiques d\'analyse vid√©o</h3>';
            
            // Stats d'√©quipe
            html += '<div class="stats-grid" style="margin-bottom: 20px;">';
            html += `
                <div class="stat-card">
                    <h3>${stats.touchesRatees || 0}</h3>
                    <p>Touches rat√©es</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.enAvants || 0}</h3>
                    <p>En-avants</p>
                </div>
            `;
            html += '</div>';
            
            // Plaquages par joueur
            if (stats.tackles && Object.keys(stats.tackles).length > 0) {
                html += '<h4 style="color: #dc3545; margin-top: 20px;">üí™ Plaquages par joueur</h4>';
                
                const tacklesList = Object.entries(stats.tackles)
                    .map(([playerId, tackles]) => {
                        const player = currentMatch.players.find(p => p.id === parseInt(playerId));
                        if (!player) return null;
                        const total = tackles.reussis + tackles.rates;
                        const pct = total > 0 ? Math.round((tackles.reussis / total) * 100) : 0;
                        return { player: player.name, ...tackles, total, pct };
                    })
                    .filter(t => t && t.total > 0)
                    .sort((a, b) => b.reussis - a.reussis);
                
                tacklesList.forEach(t => {
                    html += `
                        <div class="player-stat-item">
                            <div>
                                <strong>${t.player}</strong>: ${t.reussis} r√©ussis / ${t.rates} rat√©s (${t.total} total)
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: ${t.pct >= 80 ? '#28a745' : t.pct >= 60 ? '#ffc107' : '#dc3545'};">
                                ${t.pct}%
                            </div>
                        </div>
                    `;
                });
            }
            
            // Carte des tirs
            if (stats.kicks && stats.kicks.length > 0) {
                html += '<h4 style="color: #dc3545; margin-top: 20px;">üéØ Carte des tirs au but</h4>';
                
                const kickerStats = {};
                stats.kicks.forEach(kick => {
                    if (!kickerStats[kick.kickerId]) {
                        const player = currentMatch.players.find(p => p.id === kick.kickerId);
                        kickerStats[kick.kickerId] = {
                            name: player ? player.name : 'Inconnu',
                            transformations: { reussies: 0, tentees: 0 },
                            penalites: { reussies: 0, tentees: 0 }
                        };
                    }
                    
                    if (kick.type === 'transformation') {
                        kickerStats[kick.kickerId].transformations.tentees++;
                        if (kick.success) kickerStats[kick.kickerId].transformations.reussies++;
                    } else {
                        kickerStats[kick.kickerId].penalites.tentees++;
                        if (kick.success) kickerStats[kick.kickerId].penalites.reussies++;
                    }
                });
                
                Object.values(kickerStats).forEach(kicker => {
                    const transfoPct = kicker.transformations.tentees > 0 ? 
                        Math.round((kicker.transformations.reussies / kicker.transformations.tentees) * 100) : 0;
                    const penalitePct = kicker.penalites.tentees > 0 ? 
                        Math.round((kicker.penalites.reussies / kicker.penalites.tentees) * 100) : 0;
                    
                    html += `
                        <div class="player-stat-item">
                            <div>
                                <strong>${kicker.name}</strong><br>
                                <span style="font-size: 12px;">
                                    Transfo: ${kicker.transformations.reussies}/${kicker.transformations.tentees} (${transfoPct}%) | 
                                    P√©na: ${kicker.penalites.reussies}/${kicker.penalites.tentees} (${penalitePct}%)
                                </span>
                            </div>
                        </div>
                    `;
                });
            }
            
            videoStatsDiv.innerHTML = html;
        }

        function exportToPDF() {
            window.print();
        }

        // NOUVEAU: Export PDF des stats globales
        function exportGlobalStatsToPDF() {
            window.print();
        }

        // Statistiques globales - MODIFI√â
        function renderGlobalStats() {
            const finishedMatches = matches.filter(m => m.finished);
            
            let totalPoints = 0;
            let totalEssais = 0;
            let totalTransfoReussies = 0;
            let totalTransfoTentees = 0;
            let totalPenaliteReussies = 0;
            let totalPenaliteTentees = 0;
            
            finishedMatches.forEach(match => {
                totalPoints += match.score;
                match.events.forEach(e => {
                    if (e.type === 'essai') totalEssais++;
                    if (e.type === 'transformation') {
                        totalTransfoTentees++;
                        if (e.success) totalTransfoReussies++;
                    }
                    if (e.type === 'penalite') {
                        totalPenaliteTentees++;
                        if (e.success) totalPenaliteReussies++;
                    }
                });
            });
            
            const avgScore = finishedMatches.length > 0 ? Math.round(totalPoints / finishedMatches.length) : 0;
            const transfoRate = totalTransfoTentees > 0 ? Math.round((totalTransfoReussies / totalTransfoTentees) * 100) : 0;
            const penaliteRate = totalPenaliteTentees > 0 ? Math.round((totalPenaliteReussies / totalPenaliteTentees) * 100) : 0;
            
            document.getElementById('globalTotalMatches').textContent = finishedMatches.length;
            document.getElementById('globalTotalPoints').textContent = totalPoints;
            document.getElementById('globalTotalEssais').textContent = totalEssais;
            document.getElementById('globalTotalTransformations').textContent = totalTransfoReussies;
            document.getElementById('globalTotalPenalites').textContent = totalPenaliteReussies;
            document.getElementById('globalTransfoRate').textContent = transfoRate + '%';
            document.getElementById('globalPenaliteRate').textContent = penaliteRate + '%';
            document.getElementById('globalAverageScore').textContent = avgScore;
            
            // NOUVEAU: Stats vid√©o globales
            renderGlobalVideoStats();
            
            // Meilleurs marqueurs
            const scorers = {};
            players.forEach(p => {
                if (p.stats.totalPoints > 0) {
                    scorers[p.name] = p.stats.totalPoints;
                }
            });
            
            const sortedScorers = Object.entries(scorers).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const topScorersDiv = document.getElementById('topScorers');
            topScorersDiv.innerHTML = sortedScorers.length > 0 ? sortedScorers.map(([name, points], index) => {
                const maxPoints = sortedScorers[0][1];
                const barWidth = (points / maxPoints) * 100;
                return `
                    <div class="player-stat-item">
                        <div style="flex: 1;">
                            <strong>${index + 1}. ${name}</strong>
                            <div style="background: #e0e0e0; height: 20px; border-radius: 10px; margin-top: 5px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #dc3545, #8b0000); height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545; margin-left: 20px;">
                            ${points}
                        </div>
                    </div>
                `;
            }).join('') : '<p>Aucun point marqu√©</p>';
            
            // Meilleurs buteurs
            const kickers = {};
            players.forEach(p => {
                const total = p.stats.transformations.reussies + p.stats.penalites.reussies;
                if (total > 0) {
                    kickers[p.name] = total;
                }
            });
            
            const sortedKickers = Object.entries(kickers).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const topKickersDiv = document.getElementById('topKickers');
            topKickersDiv.innerHTML = sortedKickers.length > 0 ? sortedKickers.map(([name, kicks], index) => {
                const maxKicks = sortedKickers[0][1];
                const barWidth = (kicks / maxKicks) * 100;
                return `
                    <div class="player-stat-item">
                        <div style="flex: 1;">
                            <strong>${index + 1}. ${name}</strong>
                            <div style="background: #e0e0e0; height: 20px; border-radius: 10px; margin-top: 5px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #17a2b8, #117a8b); height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #17a2b8; margin-left: 20px;">
                            ${kicks}
                        </div>
                    </div>
                `;
            }).join('') : '<p>Aucun coup de pied r√©ussi</p>';
            
            // MODIFI√â: Tous les joueurs (pas seulement top 10)
            const playTimes = {};
            players.forEach(p => {
                if (p.stats.tempsTotal > 0) {
                    playTimes[p.name] = Math.floor(p.stats.tempsTotal / 60);
                }
            });
            
            const sortedPlayTimes = Object.entries(playTimes).sort((a, b) => b[1] - a[1]);
            const playTimeChartDiv = document.getElementById('playTimeChart');
            playTimeChartDiv.innerHTML = sortedPlayTimes.length > 0 ? sortedPlayTimes.map(([name, minutes]) => {
                const maxMinutes = sortedPlayTimes[0][1];
                const barWidth = maxMinutes > 0 ? (minutes / maxMinutes) * 100 : 0;
                return `
                    <div class="player-stat-item">
                        <div style="flex: 1;">
                            <strong>${name}</strong>
                            <div style="background: #e0e0e0; height: 20px; border-radius: 10px; margin-top: 5px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #28a745, #1e7e34); height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div style="font-size: 18px; font-weight: bold; color: #28a745; margin-left: 20px;">
                            ${minutes} min
                        </div>
                    </div>
                `;
            }).join('') : '<p>Aucun temps de jeu enregistr√©</p>';
            
            // Historique des matchs
            const matchHistoryDiv = document.getElementById('matchHistory');
            matchHistoryDiv.innerHTML = finishedMatches.length > 0 ? finishedMatches.map(match => {
                const essais = match.events.filter(e => e.type === 'essai').length;
                const transfos = match.events.filter(e => e.type === 'transformation' && e.success).length;
                const penalites = match.events.filter(e => e.type === 'penalite' && e.success).length;
                
                return `
                    <div class="match-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: #dc3545;">${match.adversaire}</h3>
                                <p>üìÖ ${new Date(match.date).toLocaleDateString('fr-FR')} - üìç ${match.lieu || 'Lieu non pr√©cis√©'}</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 48px; font-weight: bold; color: #dc3545;">${match.score} - ${match.adversaryScore || 0}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${essais} essais | ${transfos} transfo | ${penalites} p√©na
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') : '<p>Aucun match termin√©</p>';
        }

        // NOUVEAU: Afficher les stats vid√©o globales
        function renderGlobalVideoStats() {
            const videoStatsDiv = document.getElementById('globalVideoStats');
            
            // Calculer les stats globales
            let totalTouchesRatees = 0;
            let totalEnAvants = 0;
            let globalTackles = {};
            
            matches.filter(m => m.finished && m.postMatchStats).forEach(match => {
                const stats = match.postMatchStats;
                totalTouchesRatees += stats.touchesRatees || 0;
                totalEnAvants += stats.enAvants || 0;
            });
            
            // Calculer les plaquages globaux depuis les stats des joueurs
            players.forEach(p => {
                const total = p.stats.plaquages.reussis + p.stats.plaquages.rates;
                if (total > 0) {
                    globalTackles[p.name] = {
                        reussis: p.stats.plaquages.reussis,
                        rates: p.stats.plaquages.rates,
                        total: total,
                        pct: Math.round((p.stats.plaquages.reussis / total) * 100)
                    };
                }
            });
            
            const sortedTackles = Object.entries(globalTackles).sort((a, b) => b[1].reussis - a[1].reussis).slice(0, 10);
            
            let html = '<h3 style="margin-top: 40px; color: #dc3545;">üìπ Statistiques vid√©o de la saison</h3>';
            
            html += '<div class="stats-grid">';
            html += `
                <div class="stat-card">
                    <h3>${totalTouchesRatees}</h3>
                    <p>Touches rat√©es (total)</p>
                </div>
                <div class="stat-card">
                    <h3>${totalEnAvants}</h3>
                    <p>En-avants (total)</p>
                </div>
            `;
            html += '</div>';
            
            if (sortedTackles.length > 0) {
                html += '<h4 style="margin-top: 30px; color: #dc3545;">üí™ Top 10 Plaqueurs</h4>';
                sortedTackles.forEach(([name, tackles], index) => {
                    html += `
                        <div class="player-stat-item">
                            <div style="flex: 1;">
                                <strong>${index + 1}. ${name}</strong>: ${tackles.reussis} r√©ussis / ${tackles.rates} rat√©s (${tackles.total} total)
                                <div style="background: #e0e0e0; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden;">
                                    <div style="background: ${tackles.pct >= 80 ? '#28a745' : tackles.pct >= 60 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${tackles.pct}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: ${tackles.pct >= 80 ? '#28a745' : tackles.pct >= 60 ? '#ffc107' : '#dc3545'}; margin-left: 20px;">
                                ${tackles.pct}%
                            </div>
                        </div>
                    `;
                });
            }
            
            videoStatsDiv.innerHTML = html;
        }

        // Statistiques post-match
        function openPostMatchStats() {
            if (!currentMatch) return;
            
            if (!currentMatch.postMatchStats) {
                currentMatch.postMatchStats = {
                    tackles: {},
                    kicks: [],
                    touchesRatees: 0,
                    enAvants: 0
                };
                
                currentMatch.players.forEach(p => {
                    currentMatch.postMatchStats.tackles[p.id] = {
                        reussis: 0,
                        rates: 0
                    };
                });
            }
            
            const kickerSelect = document.getElementById('kickerSelect');
            kickerSelect.innerHTML = '<option value="">S√©lectionner un buteur</option>' +
                currentMatch.players.map(p => `<option value="${p.id}">#${p.number} - ${p.name}</option>`).join('');
            
            document.getElementById('touchesRatees').value = currentMatch.postMatchStats.touchesRatees || 0;
            document.getElementById('enAvants').value = currentMatch.postMatchStats.enAvants || 0;
            
            switchStatsTab('tackles');
            document.getElementById('postMatchStatsModal').classList.add('active');
        }

        function closePostMatchStats() {
            document.getElementById('postMatchStatsModal').classList.remove('active');
        }

        function switchStatsTab(tab) {
            currentStatsTab = tab;
            
            document.getElementById('statsTabTackles').style.display = 'none';
            document.getElementById('statsTabKicks').style.display = 'none';
            document.getElementById('statsTabTeam').style.display = 'none';
            
            document.querySelectorAll('#postMatchStatsModal .tab').forEach(t => t.classList.remove('active'));
            
            if (tab === 'tackles') {
                document.getElementById('statsTabTackles').style.display = 'block';
                document.getElementById('tabTackles').classList.add('active');
                renderTacklesTab();
            } else if (tab === 'kicks') {
                document.getElementById('statsTabKicks').style.display = 'block';
                document.getElementById('tabKicks').classList.add('active');
                renderKicksOnField();
            } else if (tab === 'team') {
                document.getElementById('statsTabTeam').style.display = 'block';
                document.getElementById('tabTeam').classList.add('active');
            }
        }

        function renderTacklesTab() {
            const list = document.getElementById('tacklesPlayersList');
            list.innerHTML = '';
            
            currentMatch.players.forEach(p => {
                const tackles = currentMatch.postMatchStats.tackles[p.id] || { reussis: 0, rates: 0 };
                
                const card = document.createElement('div');
                card.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #dc3545;';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <strong style="font-size: 16px;">#${p.number} - ${p.name}</strong>
                        </div>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Plaquages r√©ussis</div>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <button onclick="adjustTackles(${p.id}, 'reussis', -1)" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">-</button>
                                    <span style="font-size: 20px; font-weight: bold; color: #28a745; min-width: 40px; text-align: center;">${tackles.reussis}</span>
                                    <button onclick="adjustTackles(${p.id}, 'reussis', 1)" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">+</button>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Plaquages rat√©s</div>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <button onclick="adjustTackles(${p.id}, 'rates', -1)" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">-</button>
                                    <span style="font-size: 20px; font-weight: bold; color: #dc3545; min-width: 40px; text-align: center;">${tackles.rates}</span>
                                    <button onclick="adjustTackles(${p.id}, 'rates', 1)" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                list.appendChild(card);
            });
        }

        function adjustTackles(playerId, type, value) {
            if (!currentMatch.postMatchStats.tackles[playerId]) {
                currentMatch.postMatchStats.tackles[playerId] = { reussis: 0, rates: 0 };
            }
            
            currentMatch.postMatchStats.tackles[playerId][type] += value;
            
            if (currentMatch.postMatchStats.tackles[playerId][type] < 0) {
                currentMatch.postMatchStats.tackles[playerId][type] = 0;
            }
            
            renderTacklesTab();
        }

        function adjustTeamStat(stat, value) {
            const input = document.getElementById(stat);
            let currentValue = parseInt(input.value) || 0;
            currentValue += value;
            
            if (currentValue < 0) currentValue = 0;
            
            input.value = currentValue;
        }

        function setKickType(type) {
            currentKickType = type;
            
            document.getElementById('btnTransfo').style.opacity = type === 'transformation' ? '1' : '0.5';
            document.getElementById('btnPenalite').style.opacity = type === 'penalite' ? '1' : '0.5';
            
            document.getElementById('kickModeText').textContent = type === 'transformation' ? 'Transformation' : 'P√©nalit√©';
            
            const kickerId = document.getElementById('kickerSelect').value;
            if (!kickerId) {
                alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un buteur');
                currentKickType = null;
                document.getElementById('kickModeText').textContent = 'Aucun';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const fieldClickArea = document.getElementById('fieldClickArea');
            if (fieldClickArea) {
                fieldClickArea.addEventListener('click', function(e) {
                    if (!currentKickType) {
                        alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner le type de tir (Transformation ou P√©nalit√©)');
                        return;
                    }
                    
                    const kickerId = document.getElementById('kickerSelect').value;
                    if (!kickerId) {
                        alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un buteur');
                        return;
                    }
                    
                    const rect = document.getElementById('rugbyField').getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 400;
                    const y = ((e.clientY - rect.top) / rect.height) * 600;
                    
                    const success = confirm('Tir r√©ussi ? (OK = R√©ussi, Annuler = Rat√©)');
                    
                    const kick = {
                        kickerId: parseInt(kickerId),
                        type: currentKickType,
                        x: x,
                        y: y,
                        success: success
                    };
                    
                    currentMatch.postMatchStats.kicks.push(kick);
                    renderKicksOnField();
                    updateKickerStats();
                });
            }
        });

        function renderKicksOnField() {
            if (!currentMatch || !currentMatch.postMatchStats) return;
            
            const svg = document.getElementById('rugbyField');
            
            const existingBalls = svg.querySelectorAll('.kick-ball');
            existingBalls.forEach(ball => ball.remove());
            
            currentMatch.postMatchStats.kicks.forEach((kick, index) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', kick.x);
                circle.setAttribute('cy', kick.y);
                circle.setAttribute('r', '8');
                circle.setAttribute('fill', kick.success ? '#28a745' : '#dc3545');
                circle.setAttribute('stroke', 'white');
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('class', 'kick-ball');
                circle.style.cursor = 'pointer';
                
                circle.innerHTML = `<title>${kick.type === 'transformation' ? 'Transformation' : 'P√©nalit√©'} ${kick.success ? 'r√©ussie' : 'rat√©e'}</title>`;
                
                svg.appendChild(circle);
            });
            
            updateKickerStats();
        }

        function updateKickerStats() {
            const kickerId = document.getElementById('kickerSelect').value;
            if (!kickerId) {
                document.getElementById('kickerStatsDisplay').innerHTML = '';
                return;
            }
            
            const player = currentMatch.players.find(p => p.id === parseInt(kickerId));
            if (!player) return;
            
            const playerKicks = currentMatch.postMatchStats.kicks.filter(k => k.kickerId === parseInt(kickerId));
            
            const transfos = playerKicks.filter(k => k.type === 'transformation');
            const transfoReussies = transfos.filter(k => k.success).length;
            const transfoPct = transfos.length > 0 ? Math.round((transfoReussies / transfos.length) * 100) : 0;
            
            const penalites = playerKicks.filter(k => k.type === 'penalite');
            const penaliteReussies = penalites.filter(k => k.success).length;
            const penalitePct = penalites.length > 0 ? Math.round((penaliteReussies / penalites.length) * 100) : 0;
            
            document.getElementById('kickerStatsDisplay').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #dc3545; margin-bottom: 15px;">Statistiques de ${player.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Transformations</div>
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${transfoReussies}/${transfos.length}</div>
                            <div style="font-size: 14px; color: ${transfoPct >= 70 ? '#28a745' : transfoPct >= 50 ? '#ffc107' : '#dc3545'}; font-weight: bold;">${transfoPct}%</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">P√©nalit√©s</div>
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${penaliteReussies}/${penalites.length}</div>
                            <div style="font-size: 14px; color: ${penalitePct >= 70 ? '#28a745' : penalitePct >= 50 ? '#ffc107' : '#dc3545'}; font-weight: bold;">${penalitePct}%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function undoLastKick() {
            if (!currentMatch.postMatchStats.kicks || currentMatch.postMatchStats.kicks.length === 0) {
                alert('Aucun tir √† annuler');
                return;
            }
            
            currentMatch.postMatchStats.kicks.pop();
            renderKicksOnField();
        }

        function savePostMatchStats() {
            currentMatch.postMatchStats.touchesRatees = parseInt(document.getElementById('touchesRatees').value) || 0;
            currentMatch.postMatchStats.enAvants = parseInt(document.getElementById('enAvants').value) || 0;
            
            // CORRIG√â: Mettre √† jour les stats globales des joueurs imm√©diatement
            if (currentMatch.finished && currentMatch.postMatchStats.tackles) {
                // Retirer les anciennes stats si elles ont d√©j√† √©t√© sauvegard√©es
                if (currentMatch.tacklesAlreadySaved && currentMatch.previousTackles) {
                    currentMatch.players.forEach(matchPlayer => {
                        const player = players.find(p => p.id === matchPlayer.id);
                        if (player && currentMatch.previousTackles[matchPlayer.id]) {
                            const oldTackles = currentMatch.previousTackles[matchPlayer.id];
                            player.stats.plaquages.reussis -= oldTackles.reussis || 0;
                            player.stats.plaquages.rates -= oldTackles.rates || 0;
                            
                            if (player.stats.plaquages.reussis < 0) player.stats.plaquages.reussis = 0;
                            if (player.stats.plaquages.rates < 0) player.stats.plaquages.rates = 0;
                        }
                    });
                }
                
                // Ajouter les nouvelles stats de plaquages
                currentMatch.previousTackles = {};
                currentMatch.players.forEach(matchPlayer => {
                    const player = players.find(p => p.id === matchPlayer.id);
                    if (player && currentMatch.postMatchStats.tackles[matchPlayer.id]) {
                        const tackles = currentMatch.postMatchStats.tackles[matchPlayer.id];
                        
                        currentMatch.previousTackles[matchPlayer.id] = {
                            reussis: tackles.reussis,
                            rates: tackles.rates
                        };
                        
                        player.stats.plaquages.reussis += tackles.reussis;
                        player.stats.plaquages.rates += tackles.rates;
                    }
                });
                
                currentMatch.tacklesAlreadySaved = true;
            }
            
            saveMatchData();
            saveData(); // IMPORTANT: Sauvegarder les stats globales
            
            alert('‚úÖ Statistiques sauvegard√©es et stats individuelles mises √† jour !');
            closePostMatchStats();
            
            if (currentMatch.finished) {
                showDebrief();
            }
        }

        // Export/Import
        function exportData() {
            const data = {
                players: players,
                composition: composition,
                matches: matches,
                exportDate: new Date().toISOString(),
                version: '1.1'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rugby-stats-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Donn√©es export√©es avec succ√®s !');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.players || !Array.isArray(data.players)) {
                        throw new Error('Format de donn√©es invalide');
                    }
                    
                    const confirm = window.confirm(
                        '‚ö†Ô∏è Attention ! L\'importation va remplacer toutes vos donn√©es actuelles.\n\n' +
                        `Donn√©es √† importer:\n` +
                        `- ${data.players.length} joueurs\n` +
                        `- ${data.matches ? data.matches.length : 0} matchs\n\n` +
                        'Voulez-vous continuer ?'
                    );
                    
                    if (!confirm) {
                        event.target.value = '';
                        return;
                    }
                    
                    players = data.players || [];
                    composition = data.composition || {};
                    matches = data.matches || [];
                    
                    saveData();
                    renderPlayersStats();
                    renderMatches();
                    
                    alert('‚úÖ Donn√©es import√©es avec succ√®s !');
                    event.target.value = '';
                    
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'importation : ' + error.message);
                    event.target.value = '';
                }
            };
            
            reader.readAsText(file);
        }

        function clearAllData() {
            const confirm = window.confirm(
                '‚ö†Ô∏è ATTENTION ! Cette action va supprimer TOUTES les donn√©es :\n\n' +
                '- Tous les joueurs\n' +
                '- Tous les matchs\n' +
                '- Toutes les compositions\n' +
                '- Toutes les statistiques\n\n' +
                '‚ö†Ô∏è Cette action est IRR√âVERSIBLE !\n\n' +
                '√ätes-vous absolument s√ªr de vouloir tout r√©initialiser ?'
            );
            
            if (!confirm) return;
            
            const confirmAgain = window.confirm('Confirmez-vous vraiment la suppression totale de toutes les donn√©es ?');
            
            if (!confirmAgain) return;
            
            players = [];
            composition = {};
            matches = [];
            
            saveData();
            renderPlayersStats();
            renderMatches();
            
            alert('‚úÖ Toutes les donn√©es ont √©t√© supprim√©es.');
        }

        // Initialisation
        window.onload = function() {
            loadData();
            renderPlayersStats();
            renderMatches();
        };
    </script>
    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD2WRkyiOcGOUzteqq6W2u7XEmIjo29Tdk",
    authDomain: "statsrugby-e6fee.firebaseapp.com",
    databaseURL: "https://statsrugby-e6fee-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "statsrugby-e6fee",
    storageBucket: "statsrugby-e6fee.firebasestorage.app",
    messagingSenderId: "1081674752859",
    appId: "1:1081674752859:web:e9cd7b8df47943fed1b07e"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
</body>
</html>
